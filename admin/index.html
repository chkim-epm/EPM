<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>상품 등록 관리자</title>

  <!-- Netlify Identity -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#141b2d; --text:#e6ecff; --muted:#9fb0d1;
      --accent:#49a5ff; --accent-pressed:#3186d7; --border:#243150;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,var(--bg),#0f162b 55%, #0b1220);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Helvetica, Arial;
      color:var(--text); display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .wrap{width:100%; max-width:720px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:20px; padding:32px;
          box-shadow:0 10px 40px rgba(0,0,0,.35)}
    h1{margin:0 0 10px; font-size:26px}
    p.lead{margin:0 0 24px; color:var(--muted)}
    .actions{display:flex; gap:12px; flex-wrap:wrap}
    .btn{appearance:none; border:1px solid transparent; border-radius:12px; padding:12px 18px;
         font-weight:600; cursor:pointer; transition:.15s transform,.15s background-color,.15s border-color}
    .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
    .btn-primary{background:var(--accent); color:#081120}
    .btn-primary:active{background:var(--accent-pressed)}
    .btn-ghost{background:transparent; color:var(--text); border-color:var(--border)}
    .meta{margin-top:18px; font-size:13px; color:var(--muted)}
    [data-netlify-identity-button],[data-netlify-identity-menu]{display:none!important}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>상품 등록 관리자</h1>
      <p class="lead">GitHub 계정으로 로그인하면 CMS에서 상품을 등록·수정할 수 있어요.</p>

      <div class="actions">
        <button id="btn-login" class="btn btn-primary">GitHub으로 로그인</button>
        <button id="btn-dashboard" class="btn btn-ghost" style="display:none;">관리자 열기</button>
        <button id="btn-logout" class="btn btn-ghost" style="display:none;">로그아웃</button>
      </div>

      <p class="meta" id="meta-state">상태: 초기화 중…</p>

      <!-- 숨김: 기본 위젯 -->
      <div data-netlify-identity-button></div>
      <div data-netlify-identity-menu></div>
    </div>
  </div>

  <!-- Netlify CMS -->
  <script src="https://unpkg.com/netlify-cms-app@latest/dist/netlify-cms.js"></script>

<script>
  const $ = s => document.querySelector(s);
  const setState = s => $('#meta-state').textContent = `상태: ${s}`;

  const API_URL = 'https://eastpage.netlify.app/.netlify/identity';

  if (window.netlifyIdentity) {
    window.netlifyIdentity.init({ APIUrl: API_URL });

    window.netlifyIdentity.on('init', (user) => {
      setState(user ? (user.email || '로그인됨') : '로그아웃됨');
      $('#btn-login').style.display   = user ? 'none' : 'inline-flex';
      $('#btn-dashboard').style.display = user ? 'inline-flex' : 'none';
      $('#btn-logout').style.display = user ? 'inline-flex' : 'none';
    });

    window.netlifyIdentity.on('login', (user) => {
      setState(user.email || '로그인됨');
      location.replace('/admin/');
    });

    window.netlifyIdentity.on('logout', () => {
      setState('로그아웃됨');
      location.replace('/admin/');
    });
  } else {
    setState('Identity 위젯 로드 실패');
  }

  // 👇 GitHub 로그인 강제 실행
  $('#btn-login').addEventListener('click', () => {
    if (window.netlifyIdentity) {
      window.netlifyIdentity.open('login'); 
      // 기본 위젯이 아니라 GitHub provider 바로 호출
      window.netlifyIdentity.authenticate({ provider: "github" });
    }
  });

  $('#btn-dashboard').addEventListener('click', () => location.href = '/admin/');
  $('#btn-logout').addEventListener('click', () => window.netlifyIdentity && window.netlifyIdentity.logout());
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <!-- 반응형 레이아웃: 모바일/태블릿/데스크톱에서 적절한 확대비 유지 -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ⚠️ admin 영역은 검색엔진 노출 금지 -->
  <meta name="robots" content="noindex,nofollow" />
  <title>관리자 로그인</title>

  <script>
  // ─────────────────────────────────────────────────────────────────────────────
  // WWW 정규화:
  // - 운영 도메인을 'www.eastpowermetal.com'으로 강제하여 세션/리디렉션 오리진을 통일
  // - 호스트명이 다르면 동일 경로/쿼리/해시를 보존한 채 https://www.eastpowermetal.com 로 이동
  // ─────────────────────────────────────────────────────────────────────────────
  (function enforceWWW(){
    const CANON = "www.eastpowermetal.com";
    const allowed = [CANON, "eastpowermetal.com"];
    if (allowed.includes(location.hostname) && location.hostname !== CANON) {
      location.replace(`https://${CANON}${location.pathname}${location.search}${location.hash}`);
    }
  })();
  </script>

  <!-- Supabase JS SDK(v2): 브라우저에서 인증/스토리지를 제어하기 위한 클라이언트 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* 간단한 페이지 타이포/레이아웃 스타일 */
    body { font-family: sans-serif; max-width: 420px; margin: 48px auto; }
    button { padding: 10px 14px; font-size: 14px; cursor: pointer; }
    pre { background: #f6f6f6; padding: 12px; overflow: auto; }
  </style>
</head>
<body>
  <!-- 화면 타이틀 -->
  <h1>관리자 로그인</h1>

  <!-- 로그인 후 이동 경로 안내 텍스트 (/admin/로 복귀) -->
  <p>GitHub로 로그인하면 <code>/admin/</code>으로 돌아옵니다.</p>

  <!-- 인증 액션 버튼들 -->
  <button id="login">GitHub 로그인</button>
  <button id="logout" style="margin-left:8px;">로그아웃</button>

  <!-- 현재 세션 상태 확인용 출력 영역 -->
  <h3>세션</h3>
  <pre id="out">-</pre>

  <script>
    // ───────────────────────────────────────────────────────────────────────────
    // 1) Supabase 프로젝트 연결 정보
    // - 대시보드(API)에서 발급된 Project URL과 anon public key
    // - anon 키는 공개클라이언트에서 사용 가능한 공개키(권한은 RLS 정책에 의해 제한)
    // ───────────────────────────────────────────────────────────────────────────
    const SUPABASE_URL = "https://cwwnarmrvpvjptytepdo.supabase.co";       // ← Project URL
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3d25hcm1ydnB2anB0eXRlcGRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NzU4NTUsImV4cCI6MjA3NzQ1MTg1NX0.5mvgA_gKdlRaebVRSFIUJRKgp51zke_nffQ2jc8Ad1g"; // ← anon public key

    // ───────────────────────────────────────────────────────────────────────────
    // 2) Supabase 클라이언트 생성
    // - 브라우저 환경에서 인증/세션/스토리지 기능을 사용하기 위해 인스턴스 생성
    // ───────────────────────────────────────────────────────────────────────────
// ⭐ 쿠키 기반 Session Storage
const cookieStorage = {
  getItem: (key) => {
    const match = document.cookie.match(new RegExp('(^| )' + key + '=([^;]+)'));
    return match ? decodeURIComponent(match[2]) : null;
  },
  setItem: (key, value) => {
    document.cookie = `${key}=${encodeURIComponent(value)}; path=/; SameSite=Lax`;
  },
  removeItem: (key) => {
    document.cookie = `${key}=; Max-Age=0; path=/`;
  }
};

// 2) Supabase 클라이언트 생성
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    flowType: 'pkce',
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
    storage: cookieStorage,   // ✅ 여기만 변경
    storageKey: 'epm-admin-auth'
  }
});



    // ───────────────────────────────────────────────────────────────────────────
    // 로그인 후 복귀 경로(next) 처리
    // - URL의 ?next=/admin/xxx.html 파라미터를 읽어 리디렉션 대상 경로로 사용
    // - 파라미터가 없으면 기본값으로 /admin/product.html 사용
    //   (※ Supabase Authentication → Redirect URLs 허용 목록에 반드시 등록되어 있어야 함)
    // ───────────────────────────────────────────────────────────────────────────
    const params = new URLSearchParams(location.search);
    let nextPath = params.get('next') || '/admin/product.html';
    if (!nextPath.startsWith('/admin/')) nextPath = '/admin/product.html';

    // ───────────────────────────────────────────────────────────────────────────
    // redirectTo 오리진 결정
    // - 정상적인 http(s) 오리진이면 그대로 사용
    // - file:// 등 비정상 오리진으로 열렸을 때는 운영 도메인으로 고정하여 OAuth 실패 방지
    // ───────────────────────────────────────────────────────────────────────────
    const hasHttpOrigin = /^https?:\/\//i.test(window.location.origin);
    const baseOrigin = hasHttpOrigin ? window.location.origin : 'https://www.eastpowermetal.com';

   
    // ───────────────────────────────────────────────────────────────────────────
    // 현재 세션 정보를 <pre id="out">에 렌더링
    // - sb.auth.getSession()은 현재 탭의 세션(로그인 상태/토큰 등)을 반환
    // - 세션 객체(JSON)를 보기 좋게 출력하여 디버깅/확인에 사용
    // ───────────────────────────────────────────────────────────────────────────
    async function renderSession() {
      const { data: { session } } = await sb.auth.getSession();
      document.getElementById('out').textContent = JSON.stringify(session, null, 2) || '-';
    }
    // ✅ 이미 로그인 상태면 바로 nextPath로 이동
(async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    location.replace(nextPath);
  }
})();
    // ───────────────────────────────────────────────────────────────────────────
    // 이미 로그인 상태면 nextPath로 자동 이동
    // ───────────────────────────────────────────────────────────────────────────
sb.auth.onAuthStateChange((event, session) => {
  if (event === 'SIGNED_IN' && session) {
    location.replace(nextPath);
  }
});


    // ───────────────────────────────────────────────────────────────────────────
    // 3) GitHub OAuth 로그인 트리거
    // - Supabase의 OAuth 흐름을 시작하며, 성공 시 redirectTo로 복귀
    // - redirectTo는 반드시 Supabase Auth 설정의 Redirect URLs 화이트리스트에 포함되어야 함
    // ───────────────────────────────────────────────────────────────────────────
    document.getElementById('login').onclick = async () => {
      await sb.auth.signInWithOAuth({
        provider: 'github',
        options: {
          // 성공 후 돌아올 주소 (Authentication → URL Configuration → Redirect URLs에 반드시 등록됨)
          // ✅ 변경: 콜백을 index로 고정하고, nextPath는 쿼리로 전달(세션 저장 확정 후 이동)
          redirectTo: `${baseOrigin}/admin/index.html?next=${encodeURIComponent(nextPath)}`, // ✅ 변경
        }
      });
    };

    // ───────────────────────────────────────────────────────────────────────────
    // 4) 로그아웃
    // - 현재 탭의 세션을 해제하고 화면의 세션 표시를 갱신
    // ───────────────────────────────────────────────────────────────────────────
    document.getElementById('logout').onclick = async () => {
      await sb.auth.signOut();
      await renderSession();
      alert('로그아웃 완료');
    };

    // ───────────────────────────────────────────────────────────────────────────
    // 초기 진입 시 세션 표시
    // ───────────────────────────────────────────────────────────────────────────
    renderSession();

    // ───────────────────────────────────────────────────────────────────────────
    // 탭 간/시간 경과에 따른 인증 상태 변화 감지
    // - 다른 탭에서 로그인/로그아웃해도 현재 화면이 즉시 반영되도록 구독
    // ───────────────────────────────────────────────────────────────────────────
    sb.auth.onAuthStateChange((_event, _session) => renderSession());
  </script>
</body>
</html>

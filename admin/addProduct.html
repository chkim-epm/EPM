<!DOCTYPE html>
<html lang="ko" class="protecting">
<head>
  <meta charset="utf-8" />
  <!-- âœ… ë°˜ì‘í˜• ë©”íƒ€: ëª¨ë°”ì¼/íƒœë¸”ë¦¿/ë°ìŠ¤í¬í†±ì—ì„œ ì˜¬ë°”ë¥¸ ìŠ¤ì¼€ì¼ ìœ ì§€ -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- âš ï¸ admin ì˜ì—­ì€ ê²€ìƒ‰ì—”ì§„ ìƒ‰ì¸ ê¸ˆì§€ -->
  <meta name="robots" content="noindex,nofollow" />
  <title>ê´€ë¦¬ì ì „ìš© Â· ì œí’ˆ ë“±ë¡</title>

  <script>
    /* =========================================================================
       0) www ì •ê·œí™” (ì„¸ì…˜ ì˜¤ë¦¬ì§„ í†µì¼)
       - ì¸ì¦/ìŠ¤í† ë¦¬ì§€/ë¦¬ë””ë ‰ì…˜ì€ 'ì˜¤ë¦¬ì§„(í”„ë¡œí† ì½œ+í˜¸ìŠ¤íŠ¸+í¬íŠ¸)'ì— ë¯¼ê°
       - wwwë¡œ ì ‘ì†ì„ ê°•ì œí•´ OAuth redirect, ì¿ í‚¤/ì„¸ì…˜, CORS í˜¼ì„ ì„ ë°©ì§€
       - ë™ì¼í•œ ê²½ë¡œ/ì¿¼ë¦¬/í•´ì‹œë¥¼ ë³´ì¡´í•˜ë©° https://www.eastpowermetal.com ìœ¼ë¡œ ì´ë™
       ========================================================================= */

    // [ê¸°ì¡´ ì½”ë“œ - ë³´ê´€ìš©]
    /*
    (function enforceWWW() {
      const CANON = "www.eastpowermetal.com";
      if (location.hostname !== CANON) {
        location.replace(`https://${CANON}${location.pathname}${location.search}${location.hash}`);
      }
    })();
    */

    // [ìˆ˜ì • ì½”ë“œ - ìš´ì˜ ë„ë©”ì¸ì¼ ë•Œë§Œ www ì •ê·œí™”]
    (function enforceWWW() {
      const CANON = "www.eastpowermetal.com";
      const allowed = [CANON, "eastpowermetal.com"];
      if (allowed.includes(location.hostname) && location.hostname !== CANON) {
        location.replace(`https://${CANON}${location.pathname}${location.search}${location.hash}`);
      }
    })();
  </script>

  <!-- íŒŒë¹„ì½˜ë“¤ -->
  <link rel="icon" type="image/png" sizes="32x32" href="/epmFavicon.png">
  <link rel="shortcut icon" href="/favicon.ico">

  <style>
    /* =========================================================================
       ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° í™”ë©´ ë³´í˜¸
       - protecting í´ë˜ìŠ¤ê°€ htmlì— ìˆì„ ë•Œ bodyë¥¼ ìˆ¨ê²¨(visibility:hidden)
         'ì¸ì¦/ê¶Œí•œ ì²´í¬' ì™„ë£Œ ì „ ë¯¼ê° UI ë…¸ì¶œì„ ì°¨ë‹¨
       - CSS ë³€ìˆ˜ë¡œ ì£¼ìƒ‰/ë³´ì¡°ìƒ‰ ê´€ë¦¬
       ========================================================================= */
    html.protecting body { visibility: hidden; } /* ê²€ì¦ ì „ UI ìˆ¨ê¹€ */
    :root { --accent:#3498db; --muted:#666; --box:#f6f7f9; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Nanum Gothic, sans-serif; margin: 24px; }
    h1 { margin: 0 0 16px; font-size: 22px; }

    /* ìƒë‹¨ ì •ë³´/ë²„íŠ¼ ë°” */
    .top { display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap; }
    .top .who { color:var(--muted); }

    /* ë²„íŠ¼/í¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
    button { padding:9px 12px; border:0; border-radius:8px; cursor:pointer; }
    .btn { background: var(--accent); color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .ghost { background:#e9ecef; color:#222; }

    /* ì¢Œì¸¡: ì…ë ¥ ì¹´ë“œ / ìš°ì¸¡: ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ 2ì—´ ë ˆì´ì•„ì›ƒ(ë°˜ì‘í˜•) */
    .wrap { display:grid; grid-template-columns: 1.1fr .9fr; gap:18px; }
    .card { background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); padding:16px; }

    /* ë ˆì´ë¸”-ì…ë ¥ 2ì—´ í¼ í–‰ */
    .row { display:grid; grid-template-columns: 120px 1fr; gap:10px; align-items:center; margin-bottom:10px; }
    label { font-weight:600; }
    input[type="text"], input[type="number"], textarea {
      width:100%; padding:10px 12px; border:1px solid #d0d7de; border-radius:8px; font-size:14px;
    }
    textarea { min-height:90px; resize:vertical; }
    .hint { color:var(--muted); font-size:12px; }

    /* ìš°ì¸¡ ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ */
    .product-card { background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,.06); text-align:center; display:flex; flex-direction:column; }
    .product-card img { width:100%; height:280px; object-fit:cover; background:#f2f2f2; }
    .product-info { padding:14px; text-align:left; }
    .product-info h2 { margin:0 0 8px; font-size:18px; }
    .product-info p { margin:0 0 8px; color:#555; font-size:14px; }

    /* ìŠ¤í™ í…Œì´ë¸” */
    .product-table { margin-top:8px; }
    .product-table table { width:100%; border-collapse:collapse; }
    .product-table th, .product-table td { padding:6px 8px; border-bottom:1px solid #eee; font-size:13px; text-align:left; }

    /* ìƒíƒœ ë©”ì‹œì§€ ìƒ‰ êµ¬ë¶„ */
    .status { margin-top:10px; font-size:13px; }
    .ok { color:#0a7a0a; } .err { color:#b00020; } .muted { color:var(--muted); }

    /* 2ì¹¸ ê·¸ë¦¬ë“œ (ì¬ì§ˆ/ìš©ë„, ì¢…ë¥˜/ê°€ê²© ë“±) */
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    /* ì¢ì€ í™”ë©´ì—ì„œëŠ” 1ì—´ë¡œ ì „í™˜ */
    @media (max-width: 900px) { .wrap { grid-template-columns:1fr; } }
  </style>

  <!-- Supabase JS SDK v2: ë¸Œë¼ìš°ì €ì—ì„œ ì¸ì¦/DB/ìŠ¤í† ë¦¬ì§€ ì‚¬ìš© -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- ìƒë‹¨ ë°”: í˜„ì¬ ì‚¬ìš©ì, ëª©ë¡/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
  <div class="top">
    <strong>ê´€ë¦¬ì Â· ì œí’ˆ ë“±ë¡</strong>
    <span class="who" id="who"></span>
    <span style="flex:1"></span>
    <!-- ê´€ë¦¬ì ëª©ë¡ìœ¼ë¡œ ì´ë™ -->
    <button class="ghost" id="toListBtn" type="button" onclick="location.href='/admin/product.html'">ì œí’ˆ ëª©ë¡ ë³´ê¸°</button>
    <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ì¢Œ: ì…ë ¥ í¼ / ìš°: ë¯¸ë¦¬ë³´ê¸° -->
  <div class="wrap">
    <div class="card">
      <h1>ì‹ ê·œ ì œí’ˆ ë“±ë¡</h1>

      <!-- í•„ìˆ˜: ì œí’ˆëª… -->
      <div class="row">
        <label for="title">ì œí’ˆëª…*</label>
        <input id="title" type="text" placeholder="ì˜ˆ: ë¶€ìŠ¤ë°” Aí˜•" />
      </div>

      <!-- ì„ íƒ: ì„¤ëª… -->
      <div class="row">
        <label for="desc">ì„¤ëª…</label>
        <textarea id="desc" placeholder="ì˜ˆ: ì „ë ¥ìš© ë™ë¶€ìŠ¤ë°”, ë§ì¶¤ ì ˆë‹¨ ê°€ëŠ¥"></textarea>
      </div>

      <!-- ì¬ì§ˆ/ìš©ë„ -->
      <div class="grid2">
        <div class="row">
          <label for="material">ì¬ì§ˆ</label>
          <input id="material" type="text" placeholder="ì˜ˆ: CU + AL" />
        </div>
        <div class="row">
          <label for="usage">ìš©ë„</label>
          <input id="usage" type="text" placeholder="ì˜ˆ: ê°€ê³µë°°ì „ìš©" />
        </div>
      </div>

      <!-- ì¢…ë¥˜/ê°€ê²© -->
      <div class="grid2">
        <div class="row">
          <label for="types">ì¢…ë¥˜</label>
          <input id="types" type="text" placeholder="ì˜ˆ: T2 ~ T4" />
        </div>
        <div class="row">
          <label for="price">ê°€ê²©(ì„ íƒ)</label>
          <input id="price" type="number" step="0.01" placeholder="ì˜ˆ: 100000" />
        </div>
      </div>

      <!-- ëŒ€í‘œ ì´ë¯¸ì§€(í•„ìˆ˜) -->
      <div class="row">
        <label for="image">ëŒ€í‘œ ì´ë¯¸ì§€*</label>
        <input id="image" type="file" accept="image/*" />
      </div>

      <div class="hint">ì´ë¯¸ì§€ëŠ” ì—…ë¡œë“œ í›„ ê³µê°œ URLì„ ì œí’ˆì— ì—°ê²°í•©ë‹ˆë‹¤.</div>

      <!-- ì¶”ê°€ ì´ë¯¸ì§€(ì„ íƒ, ë‹¤ì¤‘) -->
      <div class="row">
        <label for="images">ì¶”ê°€ ì´ë¯¸ì§€</label>
        <input id="images" type="file" accept="image/*" multiple />
      </div>

      <div class="hint">ì—¬ëŸ¬ì¥ ì„ íƒ ê°€ëŠ¥ (ì„ íƒì˜µì…˜)</div>
<div id="extraPreview" style="display:flex; gap:6px; flex-wrap:wrap; margin-top:6px;"></div>
      
      <!-- ì œì¶œ ë²„íŠ¼ / ìƒíƒœ ë©”ì‹œì§€ -->
      <label></label>
      <div>
        <button class="btn" id="submitBtn">ë“±ë¡</button>
        <span id="status" class="status muted"></span>
      </div>
    </div>

    <!-- ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ: ì…ë ¥/ì´ë¯¸ì§€ ì„ íƒ ì‹œ ì¦‰ì‹œ ë°˜ì˜ -->
    <div class="card">
      <h1>ë¯¸ë¦¬ë³´ê¸°</h1>

      <div class="product-card">
        <!-- ê¸°ë³¸ í”„ë¦¬ë·° SVG(íšŒìƒ‰ ë°”íƒ•) â†’ ëŒ€í‘œ ì´ë¯¸ì§€ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°ë¡œ êµì²´ -->
        <img
          id="prevImg"
          alt="ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€"
          src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='900'%3E%3Crect width='100%25' height='100%25' fill='%23f2f2f2'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23999' font-family='system-ui' font-size='24'%3EPreview%3C/text%3E%3C/svg%3E"
        />
        <div class="product-info">
          <h2 id="prevTitle">ì œí’ˆëª…</h2>
          <p id="prevDesc">ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>

          <!-- ìŠ¤í™ í…Œì´ë¸” ë¯¸ë¦¬ë³´ê¸° -->
          <div class="product-table">
            <table>
              <tbody>
                <tr><th>í’ˆëª©ëª…</th><td id="prevTitle2">-</td></tr>
                <tr><th>ì¬ì§ˆ</th><td id="prevMaterial">-</td></tr>
                <tr><th>ìš©ë„</th><td id="prevUsage">-</td></tr>
                <tr><th>ì¢…ë¥˜</th><td id="prevTypes">-</td></tr>
                <tr><th>ê°€ê²©</th><td id="prevPrice">-</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="status muted" style="margin-top:8px;">
        * í¼ ì…ë ¥ê³¼ ì´ë¯¸ì§€ ì„ íƒ ì‹œ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <script>
    // =========================
    // ğŸ”§ Supabase & ì •ì±… ìƒìˆ˜
    // =========================
    const SUPABASE_URL = "https://cwwnarmrvpvjptytepdo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3d25hcm1ydnB2anB0eXRlcGRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NzU4NTUsImV4cCI6MjA3NzQ1MTg1NX0.5mvgA_gKdlRaebVRSFIUJRKgp51zke_nffQ2jc8Ad1g";
    const BUCKET = "product-image";              // ìŠ¤í† ë¦¬ì§€ ë²„í‚·ëª…(ëŒ€í‘œ/ì¶”ê°€ ì´ë¯¸ì§€ ì €ì¥ ìœ„ì¹˜)

    const ADMIN_EMAILS = ["chkim.epm@gmail.com"]; // í—ˆìš© ì´ë©”ì¼ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸
    const ADMIN_USERNAMES = ["chkim-epm"];        // í—ˆìš© GitHub username í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸

    const LOGIN_URL  = "/admin/index.html";       // ë¯¸ë¡œê·¸ì¸ ì‹œ ì´ë™
    const DENIED_URL = "/admin/denied.html";      // ê¶Œí•œ ì—†ìŒ ì‹œ ì´ë™

    // Supabase ë¸Œë¼ìš°ì € í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤
   // â­ ì¿ í‚¤ ê¸°ë°˜ Session Storage (ë¸Œë¼ìš°ì € ì¢…ë£Œ ì‹œ ë¡œê·¸ì¸ íœ˜ë°œ)
// â­ ì¿ í‚¤ ê¸°ë°˜ Session Storage (ëŒ€ìš©ëŸ‰ ëŒ€ì‘: ì¿ í‚¤ ìª¼ê°œì„œ ì €ì¥)
// - ë¸Œë¼ìš°ì € ì¢…ë£Œ ì‹œ íœ˜ë°œ: Expires/Max-Age ì—†ì´ "ì„¸ì…˜ ì¿ í‚¤"ë¡œ ì €ì¥
// - 1ì¿ í‚¤ 4KB ì œí•œ íšŒí”¼: keyë¥¼ key.0, key.1 ...ë¡œ ë¶„í•  ì €ì¥
const cookieStorage = (() => {
  const CHUNK_SIZE = 3000; // ì•ˆì „ ì—¬ìœ  (ì¿ í‚¤ ì˜¤ë²„í—¤ë“œ ê³ ë ¤)
  const OPTS = "path=/; SameSite=Lax; Domain=.eastpowermetal.com"; // âœ… ë³€ê²½: www/non-www ëª¨ë‘ì—ì„œ ì¿ í‚¤ ê³µìœ 

  const getCookie = (name) => {
    const m = document.cookie.match(new RegExp("(^| )" + name.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + "=([^;]+)"));
    return m ? decodeURIComponent(m[2]) : null;
  };

  const setCookie = (name, value) => {
    document.cookie = `${name}=${encodeURIComponent(value)}; ${OPTS}`;
  };

  const delCookie = (name) => {
    document.cookie = `${name}=; Max-Age=0; path=/; Domain=.eastpowermetal.com`; // âœ… ë³€ê²½: ì‚­ì œë„ ë™ì¼ ë„ë©”ì¸ ë²”ìœ„ë¡œ
  };

  return {
    getItem: (key) => {
      const meta = getCookie(`${key}.__chunks`);
      if (!meta) return getCookie(key); // (ê³¼ê±° ë‹¨ì¼ ì¿ í‚¤ í˜¸í™˜)
      const n = Number(meta);
      if (!Number.isFinite(n) || n <= 0) return null;

      let out = "";
      for (let i = 0; i < n; i++) {
        const part = getCookie(`${key}.${i}`);
        if (part == null) return null; // ì¤‘ê°„ ì¡°ê° ëˆ„ë½
        out += part;
      }
      return out;
    },

    setItem: (key, value) => {
      // ê¸°ì¡´ ì¡°ê° ì œê±°
      const old = getCookie(`${key}.__chunks`);
      if (old) {
        const nOld = Number(old);
        if (Number.isFinite(nOld) && nOld > 0) {
          for (let i = 0; i < nOld; i++) delCookie(`${key}.${i}`);
        }
        delCookie(`${key}.__chunks`);
      }
      delCookie(key); // ë‹¨ì¼ ì¿ í‚¤ ì“°ë˜ í”ì  ì œê±°

      // ë¶„í•  ì €ì¥
      const str = String(value ?? "");
      const chunks = [];
      for (let i = 0; i < str.length; i += CHUNK_SIZE) {
        chunks.push(str.slice(i, i + CHUNK_SIZE));
      }
      setCookie(`${key}.__chunks`, String(chunks.length));
      chunks.forEach((c, i) => setCookie(`${key}.${i}`, c));
    },

    removeItem: (key) => {
      const meta = getCookie(`${key}.__chunks`);
      if (meta) {
        const n = Number(meta);
        if (Number.isFinite(n) && n > 0) {
          for (let i = 0; i < n; i++) delCookie(`${key}.${i}`);
        }
        delCookie(`${key}.__chunks`);
      }
      delCookie(key);
    }
  };
})();


// Supabase ë¸Œë¼ìš°ì € í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    flowType: 'pkce',
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
    storage: cookieStorage,
    storageKey: 'epm-admin-auth'
  }
});
    
// âœ… [ì¶”ê°€] ìˆ˜ì • ëª¨ë“œ íŒë‹¨ìš©: URL ?id= ê°€ ìˆìœ¼ë©´ ìˆ˜ì • ëª¨ë“œ
const EDIT_ID = new URLSearchParams(location.search).get("id");
const IS_EDIT = !!EDIT_ID;


    /* -------------------------------------------------------------------------
       URLì— OAuth code/access_tokenì´ ì‹¤ë ¤ì˜¨ ê²½ìš° ì„¸ì…˜ êµí™˜
       - GitHub OAuth ì„±ê³µ í›„ Supabaseê°€ ë¶€ì—¬í•œ code/hashë¥¼ ì„¸ì…˜ìœ¼ë¡œ ë°”ê¿” ë¡œê·¸ì¸ í™•ë¦½
       ------------------------------------------------------------------------- */
    async function ensureSessionFromURL() {
      if (location.search.includes("code=") || location.hash.includes("access_token")) {
        try { await sb.auth.exchangeCodeForSession(window.location.href); } catch (_) {}
      }
    }

    /* -------------------------------------------------------------------------
       1) ê´€ë¦¬ì ê°€ë“œ
       - â‘  ì„¸ì…˜ ì¡°íšŒ: userê°€ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
       - â‘¡ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸(email ë˜ëŠ” GitHub user_name) ê²€ì¦
       - â‘¢ í†µê³¼ ì‹œ protecting í•´ì œ + ì‚¬ìš©ì í‘œê¸°
       ------------------------------------------------------------------------- */
async function guardAdmin() {
  let session;

  try {
    const timeout = (ms) =>
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error("getSession timeout")), ms)
      );

    const { data, error } = await Promise.race([
      sb.auth.getSession(),
      timeout(2000) // âœ… 2ì´ˆ íƒ€ì„ì•„ì›ƒ
    ]);

    if (error) throw error;
    session = data?.session;
  } catch (e) {
    console.error("[guard] getSession error:", e);

    // âœ… í° í™”ë©´ ë°©ì§€: ì¼ë‹¨ í™”ë©´ ì—´ê³  ì•ˆë‚´/ë¡œê·¸ í™•ì¸ ê°€ëŠ¥í•˜ê²Œ
    document.documentElement.classList.remove("protecting");

    // ì›í•˜ë©´ ì—¬ê¸°ì„œ ë¡œê·¸ì¸ìœ¼ë¡œ ë³´ë‚´ë„ ë¨:
    // kickLogin();
    return;
  }

  const user = session?.user;
  if (!user) return kickLogin();

  const email = user.email;
  const ghUser = user.user_metadata?.user_name;
  const ok =
    (email && ADMIN_EMAILS.includes(email)) ||
    (ghUser && ADMIN_USERNAMES.includes(ghUser));

  if (!ok) return kickDenied();

  document.getElementById("who").textContent = `(${email || ghUser})`;
  document.documentElement.classList.remove("protecting");
}


    // ë¯¸ë¡œê·¸ì¸ ì‹œ í˜„ì¬ URLì„ nextë¡œ ë¶™ì—¬ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë³´ëƒ„ â†’ ë¡œê·¸ì¸ í›„ ì›ìœ„ì¹˜ ë³µê·€ ê°€ëŠ¥
    function kickLogin() {

      // [ê¸°ì¡´ ì½”ë“œ - ë³´ê´€ìš©]
      // const next = encodeURIComponent(location.pathname + location.search);

      // [ìˆ˜ì • ì½”ë“œ - hashê¹Œì§€ í¬í•¨]
      const next = encodeURIComponent(location.pathname + location.search + location.hash);

      location.replace(`${LOGIN_URL}?next=${next}`);
    }

    // ë¡œê·¸ì¸ì€ í–ˆì§€ë§Œ ê¶Œí•œì´ ì—†ëŠ” ê³„ì • â†’ denied í˜ì´ì§€ë¡œ ì´ë™
    function kickDenied() {
      location.replace(DENIED_URL);
    }

    /* -------------------------------------------------------------------------
       ê°€ë“œ í´ë°±(ì•ˆì „ì¥ì¹˜)
       - ë„¤íŠ¸ì›Œí¬/ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜ë¡œ protecting í•´ì œê°€ ì•ˆ ë˜ë©´ 5ì´ˆ í›„ ë¡œê·¸ì¸ìœ¼ë¡œ ìœ ë„
       ------------------------------------------------------------------------- */

    // [ê¸°ì¡´ ì½”ë“œ - ë³´ê´€ìš©]
    /* ===================== [ì¶”ê°€/ìˆ˜ì •ëœ ë¶€ë¶„ ì‹œì‘] =====================
       ê¸°ì¡´ í´ë°±ì€ 5ì´ˆ í›„ ë¬´ì¡°ê±´ kickLogin()ì´ë¼
       ë„¤íŠ¸ì›Œí¬/ì´ˆê¸°í™” ì§€ì—° ì‹œ "ì„¸ì…˜ì´ ìˆëŠ”ë°ë„" íŠ•ê¸¸ ìˆ˜ ìˆìŒ.
       -> í´ë°±ì—ì„œ í•œ ë²ˆ ë” ì„¸ì…˜ í™•ì¸ í›„ ì—†ì„ ë•Œë§Œ ë¡œê·¸ì¸ìœ¼ë¡œ ë³´ëƒ„.
    */
    // setTimeout(() => {
    //   if (document.documentElement.classList.contains('protecting')) {
    //     kickLogin();
    //   }
    // }, 5000);

    setTimeout(async () => {
      if (!document.documentElement.classList.contains('protecting')) return;
      const { data: { session } } = await sb.auth.getSession();
      if (!session) kickLogin();
      else document.documentElement.classList.remove("protecting");
    }, 5000);
    /* ===================== [ì¶”ê°€/ìˆ˜ì •ëœ ë¶€ë¶„ ë] ===================== */

    
 // íƒ­/ì°½ ê°„ ì¸ì¦ ìƒíƒœ ë³€í™”ì—ë„ ê°€ë“œë¥¼ ì¬í‰ê°€
sb.auth.onAuthStateChange(() => guardAdmin());


// âœ… [ì¶”ê°€] ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ê¸°ì¡´ ì œí’ˆ ì •ë³´ ë¡œë“œí•´ì„œ í¼ ì±„ìš°ê¸°
async function loadForEdit(productId) {
  const { data, error } = await sb
    .from("product")
    .select("*")
    .eq("id", productId)
    .single();

  if (error) throw error;
  if (!data) throw new Error("ì œí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

  $("title").value = data.title || "";
  $("desc").value = data.description || "";
  $("material").value = data.material || "";
  $("usage").value = data.usage || "";
  $("types").value = data.types || "";
  $("price").value = (data.price ?? "");

  if (data.image_url) $("prevImg").src = data.image_url;

  const h1 = document.querySelector(".card h1");
  if (h1) h1.textContent = "ì œí’ˆ ìˆ˜ì •";
  const submitBtn = $("submitBtn");
  if (submitBtn) submitBtn.textContent = "ìˆ˜ì • ì €ì¥";

  updatePreview();
}
    // âœ… ê¸°ì¡´ ì¶”ê°€ ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
const { data: imgs } = await sb
  .from("product_image")
  .select("id,url")
  .eq("product_id", productId);

if (imgs && imgs.length) {
  const wrap = $("extraPreview");
  wrap.innerHTML = imgs.map(img => `
    <img src="${img.url}"
         style="width:80px;height:80px;object-fit:cover;border-radius:6px;">
  `).join("");
}



// âœ… [êµì²´ëœ ì´ˆê¸° ì§„ì… ì‹œí€€ìŠ¤]
(async () => {
  try {
    await ensureSessionFromURL();
    await guardAdmin();

    // âœ… ìˆ˜ì • ëª¨ë“œì¼ ê²½ìš° ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    if (IS_EDIT) {
      await loadForEdit(EDIT_ID);
    }
  } catch (e) {
    console.error(e);
    document.documentElement.classList.remove("protecting");
  }
})();


    /* -------------------------------------------------------------------------
       2) ë¯¸ë¦¬ë³´ê¸° ë°”ì¸ë”©
       - ì…ë ¥ê°’ ë³€ë™, ëŒ€í‘œ ì´ë¯¸ì§€ ì„ íƒ ì‹œ ìš°ì¸¡ 'ë¯¸ë¦¬ë³´ê¸°' ì¹´ë“œì— ì¦‰ì‹œ ë°˜ì˜
       - ëŒ€í‘œ ì´ë¯¸ì§€ëŠ” FileReaderë¡œ DataURLì„ ë§Œë“¤ì–´ <img> srcë¡œ ì£¼ì…
       ------------------------------------------------------------------------- */
    const $ = (id) => document.getElementById(id);

    ["title", "desc", "material", "usage", "types", "price"].forEach(id => {
      $(id).addEventListener("input", updatePreview);
    });

    $("image").addEventListener("change", updatePreview);

    function updatePreview() {
      $("prevTitle").textContent  = $("title").value || "ì œí’ˆëª…";
      $("prevTitle2").textContent = $("title").value || "-";
      $("prevDesc").textContent   = $("desc").value || "ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
      $("prevMaterial").textContent = $("material").value || "-";
      $("prevUsage").textContent    = $("usage").value || "-";
      $("prevTypes").textContent    = $("types").value || "-";
      $("prevPrice").textContent    = $("price").value ? Number($("price").value).toLocaleString() : "-";

      const file = $("image").files?.[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => $("prevImg").src = e.target.result;
        reader.readAsDataURL(file);
      }
    }
    updatePreview(); // ì´ˆê¸° í”„ë¦¬ë·° ë Œë”

    /* -------------------------------------------------------------------------
       3) ë¡œê·¸ì•„ì›ƒ
       - Supabase ì„¸ì…˜ ì¢…ë£Œ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™(ë³µê·€ ê²½ë¡œëŠ” indexì—ì„œ ì²˜ë¦¬)
       ------------------------------------------------------------------------- */
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await sb.auth.signOut();
      kickLogin();
    });

    /* -------------------------------------------------------------------------
       4) ì œí’ˆ ë“±ë¡ í”Œë¡œìš°
       - ìœ íš¨ì„± ê²€ì‚¬(í•„ìˆ˜: ì œí’ˆëª…/ëŒ€í‘œ ì´ë¯¸ì§€)
       - ì‚¬ìš©ì ê¶Œí•œ ì¬ê²€ì¦(ì„¸ì…˜/í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸)
       - ìŠ¤í† ë¦¬ì§€ì— ëŒ€í‘œ ì´ë¯¸ì§€ ì—…ë¡œë“œ â†’ ê³µê°œ URL íšë“
       - product í…Œì´ë¸”ì— ì œí’ˆ ë©”íƒ€ë°ì´í„° insert â†’ id íšë“
       - ì¶”ê°€ ì´ë¯¸ì§€(ì—¬ëŸ¬ ì¥) ì—…ë¡œë“œ â†’ product_image í…Œì´ë¸”ì— ì—°ê²° insert
       - ìƒíƒœ ë©”ì‹œì§€ë¡œ ì§„í–‰/ì„±ê³µ/ì‹¤íŒ¨ í‘œì‹œ
       ------------------------------------------------------------------------- */
document.getElementById("submitBtn").addEventListener("click", async () => {
  const imagesInput = document.getElementById("images");
  const status = $("status");
  const submitBtn = $("submitBtn");

  status.className = "status muted";
  status.textContent = IS_EDIT ? "ìˆ˜ì • ì¤‘..." : "ì—…ë¡œë“œ ì¤‘...";
  submitBtn.disabled = true;

  const title = $("title").value.trim();
  const file  = $("image").files?.[0]; // ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” ì•ˆ ë„£ì–´ë„ ë  ìˆ˜ ìˆìŒ

  if (!title) { status.className="status err"; status.textContent="ì œí’ˆëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."; submitBtn.disabled=false; return; }
  if (!IS_EDIT && !file) { status.className="status err"; status.textContent="ëŒ€í‘œ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”."; submitBtn.disabled=false; return; }

  try {
    // ê¶Œí•œ ì¬ê²€ì¦
    const { data: { session } } = await sb.auth.getSession();
    const user = session?.user;
    const email = user?.email;
    const ghUser = user?.user_metadata?.user_name;
    const ok = user && ((email && ADMIN_EMAILS.includes(email)) || (ghUser && ADMIN_USERNAMES.includes(ghUser)));
    if (!ok) { kickLogin(); return; }

    // âœ… ê³µí†µ payload (image_urlì€ ì•„ë˜ì—ì„œ ì¡°ê±´ì ìœ¼ë¡œ ì¶”ê°€)
    const payload = {
      title,
      description: $("desc").value || null,
      material: $("material").value || null,
      usage: $("usage").value || null,
      types: $("types").value || null,
      price: $("price").value ? Number($("price").value) : null,
    };

    // âœ… ëŒ€í‘œ ì´ë¯¸ì§€ ì—…ë¡œë“œëŠ” "íŒŒì¼ì„ ìƒˆë¡œ ì„ íƒí•œ ê²½ìš°ì—ë§Œ" ìˆ˜í–‰
    if (file) {
      const safeBase = file.name
        .normalize("NFKD")
        .replace(/[^\w.\-]+/g, "_")
        .replace(/^_+|_+$/g, "");

      const mainName = `${Date.now()}_${safeBase}`.replace(/_+/g, "_");
      const mainPath = `product/${mainName}`;

      const { error: upErr } = await sb.storage
        .from(BUCKET)
        .upload(mainPath, file, {
          upsert: false,
          cacheControl: "3600",
          contentType: file.type || "application/octet-stream",
        });
      if (upErr) throw upErr;

      const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(mainPath);
      payload.image_url = pub.publicUrl;
    }

    let productId = EDIT_ID;

    // âœ… ì‹ ê·œ vs ìˆ˜ì • ë¶„ê¸°
    if (IS_EDIT) {
      const { error: upErr } = await sb
        .from("product")
        .update(payload)
        .eq("id", EDIT_ID);
      if (upErr) throw upErr;
    } else {
      const insertResult = await sb
        .from("product")
        .insert(payload)
        .select("id")
        .single();
      if (insertResult.error) throw insertResult.error;
      productId = insertResult.data.id;
    }

    // âœ… ì¶”ê°€ ì´ë¯¸ì§€ëŠ” "ì„ íƒëœ ê²ƒë§Œ" ì—…ë¡œë“œí•´ì„œ product_imageì— insert
    const extras = imagesInput?.files ? Array.from(imagesInput.files) : [];
    if (extras.length) {
      const baseDir = `product/${productId}`;
      for (const f of extras) {
        const safe = f.name
          .normalize("NFKD")
          .replace(/[^\w.\-]+/g, "_")
          .replace(/^_+|_+$/g, "");
        const name = `${Date.now()}_${safe}`.replace(/_+/g, "_");
        const p = `${baseDir}/${name}`;

        const { error: upErr2 } = await sb.storage
          .from(BUCKET)
          .upload(p, f, {
            upsert: false,
            cacheControl: "3600",
            contentType: f.type || "application/octet-stream",
          });
        if (upErr2) throw upErr2;

        const { data: pub2 } = sb.storage.from(BUCKET).getPublicUrl(p);
        const insImg = await sb.from("product_image").insert({
          product_id: productId,
          url: pub2.publicUrl,
        });
        if (insImg.error) throw insImg.error;
      }
    }

    status.className = "status ok";
    status.textContent = IS_EDIT ? "ìˆ˜ì • ì™„ë£Œ!" : "ë“±ë¡ ì™„ë£Œ!";
  } catch (e) {
    console.error(e);
    status.className = "status err";
    status.textContent = (IS_EDIT ? "ìˆ˜ì • ì‹¤íŒ¨: " : "ë“±ë¡ ì‹¤íŒ¨: ") + (e?.message || e);
  } finally {
    submitBtn.disabled = false;
  }
});

  </script>
</body>
</html>

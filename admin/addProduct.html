<!DOCTYPE html>
<html lang="ko" class="protecting">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>ê´€ë¦¬ì ì „ìš© Â· ì œí’ˆ ë“±ë¡</title>
    <script>
	/* ===== 0) www ì •ê·œí™” (ì„¸ì…˜ ì˜¤ë¦¬ì§„ í†µì¼) ===== */
    (function enforceWWW(){
      const CANON = "www.eastpowermetal.com";
      if (location.hostname !== CANON) {
        location.replace(`https://${CANON}${location.pathname}${location.search}${location.hash}`);
      }
    })();
  </script>
  
  <link rel="icon" type="image/png" sizes="32x32" href="/epmFavicon.png">
  <link rel="shortcut icon" href="/favicon.ico">
  <style>
    html.protecting body { visibility: hidden; } /* ê²€ì¦ ì „ UI ìˆ¨ê¹€ */
    :root { --accent:#3498db; --muted:#666; --box:#f6f7f9; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Nanum Gothic, sans-serif; margin: 24px; }
    h1 { margin: 0 0 16px; font-size: 22px; }
    .top { display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap; }
    .top .who{ color:var(--muted); }
    button { padding:9px 12px; border:0; border-radius:8px; cursor:pointer; }
    .btn { background: var(--accent); color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .ghost { background:#e9ecef; color:#222; }
    .wrap { display:grid; grid-template-columns: 1.1fr .9fr; gap:18px; }
    .card { background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); padding:16px; }
    .row { display:grid; grid-template-columns: 120px 1fr; gap:10px; align-items:center; margin-bottom:10px; }
    label{ font-weight:600; }
    input[type="text"], input[type="number"], textarea {
      width:100%; padding:10px 12px; border:1px solid #d0d7de; border-radius:8px; font-size:14px;
    }
    textarea{ min-height:90px; resize:vertical; }
    .hint{ color:var(--muted); font-size:12px; }
    .product-card { background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,.06); text-align:center; display:flex; flex-direction:column; }
    .product-card img { width:100%; height:280px; object-fit:cover; background:#f2f2f2; }
    .product-info { padding:14px; text-align:left; }
    .product-info h2{ margin:0 0 8px; font-size:18px; }
    .product-info p{ margin:0 0 8px; color:#555; font-size:14px; }
    .product-table { margin-top:8px; }
    .product-table table{ width:100%; border-collapse: collapse; }
    .product-table th, .product-table td{ padding:6px 8px; border-bottom:1px solid #eee; font-size:13px; text-align:left; }
    .status { margin-top:10px; font-size:13px; }
    .ok{ color:#0a7a0a; } .err{ color:#b00020; } .muted{ color:var(--muted); }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 900px){ .wrap{ grid-template-columns:1fr; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="top">
    <strong>ê´€ë¦¬ì Â· ì œí’ˆ ë“±ë¡</strong>
    <span class="who" id="who"></span>
    <span style="flex:1"></span>
    <!-- ê´€ë¦¬ì ëª©ë¡ìœ¼ë¡œ -->
    <button class="ghost" onclick="location.href='https://www.eastpowermetal.com/admin/product.html'">ì œí’ˆ ëª©ë¡ ë³´ê¸°</button>
    <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <div class="wrap">
    <div class="card">
      <h1>ì‹ ê·œ ì œí’ˆ ë“±ë¡</h1>
      <div class="row">
        <label for="title">ì œí’ˆëª…*</label>
        <input id="title" type="text" placeholder="ì˜ˆ: ë¶€ìŠ¤ë°” Aí˜•" />
      </div>
      <div class="row">
        <label for="desc">ì„¤ëª…</label>
        <textarea id="desc" placeholder="ì˜ˆ: ì „ë ¥ìš© ë™ë¶€ìŠ¤ë°”, ë§ì¶¤ ì ˆë‹¨ ê°€ëŠ¥"></textarea>
      </div>
      <div class="grid2">
        <div class="row">
          <label for="material">ì¬ì§ˆ</label>
          <input id="material" type="text" placeholder="ì˜ˆ: CU + AL" />
        </div>
        <div class="row">
          <label for="usage">ìš©ë„</label>
          <input id="usage" type="text" placeholder="ì˜ˆ: ê°€ê³µë°°ì „ìš©" />
        </div>
      </div>
      <div class="grid2">
        <div class="row">
          <label for="types">ì¢…ë¥˜</label>
          <input id="types" type="text" placeholder="ì˜ˆ: T2 ~ T4" />
        </div>
        <div class="row">
          <label for="price">ê°€ê²©(ì„ íƒ)</label>
          <input id="price" type="number" step="0.01" placeholder="ì˜ˆ: 100000" />
        </div>
      </div>
      <div class="row">
        <label for="image">ëŒ€í‘œ ì´ë¯¸ì§€*</label>
        <input id="image" type="file" accept="image/*" />
      </div>
      <div class="hint">ì´ë¯¸ì§€ëŠ” ì—…ë¡œë“œ í›„ ê³µê°œ URLì„ ì œí’ˆì— ì—°ê²°í•©ë‹ˆë‹¤.</div>
      <div class="row">
        <label for="images">ì¶”ê°€ ì´ë¯¸ì§€</label>
        <input id="images" type="file" accept="image/*" multiple />
      </div>
      <div class="hint">ì—¬ëŸ¬ì¥ ì„ íƒ ê°€ëŠ¥ (ì„ íƒì˜µì…˜)</div>
      <label></label>
      <div>
        <button class="btn" id="submitBtn">ë“±ë¡</button>
        <span id="status" class="status muted"></span>
      </div>
    </div>

    <div class="card">
      <h1>ë¯¸ë¦¬ë³´ê¸°</h1>
      <div class="product-card">
        <img id="prevImg" alt="ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€"
             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='900'%3E%3Crect width='100%25' height='100%25' fill='%23f2f2f2'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23999' font-family='system-ui' font-size='24'%3EPreview%3C/text%3E%3C/svg%3E" />
        <div class="product-info">
          <h2 id="prevTitle">ì œí’ˆëª…</h2>
          <p id="prevDesc">ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
          <div class="product-table">
            <table>
              <tbody>
                <tr><th>í’ˆëª©ëª…</th><td id="prevTitle2">-</td></tr>
                <tr><th>ì¬ì§ˆ</th><td id="prevMaterial">-</td></tr>
                <tr><th>ìš©ë„</th><td id="prevUsage">-</td></tr>
                <tr><th>ì¢…ë¥˜</th><td id="prevTypes">-</td></tr>
                <tr><th>ê°€ê²©</th><td id="prevPrice">-</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="status muted" style="margin-top:8px;">* í¼ ì…ë ¥ê³¼ ì´ë¯¸ì§€ ì„ íƒ ì‹œ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤.</div>
    </div>
  </div>

  <script>
    // =========================
    // ğŸ”§ Supabase & ì •ì±…
    // =========================
    const SUPABASE_URL = "https://cwwnarmrvpvjptytepdo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3d25hcm1ydnB2anB0eXRlcGRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NzU4NTUsImV4cCI6MjA3NzQ1MTg1NX0.5mvgA_gKdlRaebVRSFIUJRKgp51zke_nffQ2jc8Ad1g";
    const BUCKET = "product-image";

    const ADMIN_EMAILS = ["chkim.epm@gmail.com"];
    const ADMIN_USERNAMES = ["chkim-epm"];

    const LOGIN_URL  = "/admin/index.html";
    const DENIED_URL = "/admin/denied.html";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* URLì— code/access_token ìˆì„ ë•Œë§Œ OAuth ì„¸ì…˜ êµí™˜ */
    async function ensureSessionFromURL() {
      if (location.search.includes("code=") || location.hash.includes("access_token")) {
        try { await sb.auth.exchangeCodeForSession(window.location.href); } catch (_) {}
      }
    }

    /* ===== 1) ê´€ë¦¬ì ê°€ë“œ ===== */
    async function guardAdmin() {
      const { data: { session } } = await sb.auth.getSession();
      const user = session?.user;
      if (!user) return kickLogin();

      const email = user.email;
      const ghUser = user.user_metadata?.user_name;
      const ok = (email && ADMIN_EMAILS.includes(email)) || (ghUser && ADMIN_USERNAMES.includes(ghUser));
      if (!ok) return kickDenied();

      document.getElementById("who").textContent = `(${email || ghUser})`;
      document.documentElement.classList.remove("protecting");
    }

    function kickLogin(){
      const next = encodeURIComponent(location.pathname + location.search);
      location.replace(`${LOGIN_URL}?next=${next}`);
    }
    function kickDenied(){
      location.replace(DENIED_URL);
    }

    /* 1-1) ê°€ë“œ ì‹¤íŒ¨/ì—ëŸ¬ë¡œ í™”ë©´ì´ ê³„ì† ìˆ¨ê²¨ì§€ì§€ ì•Šë„ë¡ ì•ˆì „ì¥ì¹˜ */
    setTimeout(() => {
      if (document.documentElement.classList.contains('protecting')) {
        // í´ë°±: ë¡œê·¸ì¸ìœ¼ë¡œ ë³´ëƒ„
        kickLogin();
      }
    }, 5000);

    sb.auth.onAuthStateChange(() => guardAdmin());

    (async () => {
      await ensureSessionFromURL(); // â‘  OAuth ì½”ë“œ êµí™˜
      await guardAdmin();           // â‘¡ ê¶Œí•œ í™•ì¸ â†’ UI ì˜¤í”ˆ
    })();

    /* ===== 2) ë¯¸ë¦¬ë³´ê¸° ë°”ì¸ë”© ===== */
    const $ = (id)=>document.getElementById(id);
    ["title","desc","material","usage","types","price"].forEach(id=>{
      $(id).addEventListener("input", updatePreview);
    });
    $("image").addEventListener("change", updatePreview);

    function updatePreview(){
      $("prevTitle").textContent = $("title").value || "ì œí’ˆëª…";
      $("prevTitle2").textContent = $("title").value || "-";
      $("prevDesc").textContent = $("desc").value || "ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
      $("prevMaterial").textContent = $("material").value || "-";
      $("prevUsage").textContent = $("usage").value || "-";
      $("prevTypes").textContent = $("types").value || "-";
      $("prevPrice").textContent = $("price").value ? Number($("price").value).toLocaleString() : "-";

      const file = $("image").files?.[0];
      if (file){
        const reader = new FileReader();
        reader.onload = e => $("prevImg").src = e.target.result;
        reader.readAsDataURL(file);
      }
    }
    updatePreview();

    /* ===== 3) ë¡œê·¸ì•„ì›ƒ ===== */
    document.getElementById("logoutBtn").addEventListener("click", async ()=>{
      await sb.auth.signOut();
      kickLogin();
    });

    /* ===== 4) ì œí’ˆ ë“±ë¡ ===== */
    document.getElementById("submitBtn").addEventListener("click", async () => {
      const imagesInput = document.getElementById("images");
      const status = $("status");
      const submitBtn = $("submitBtn");

      status.className = "status muted";
      status.textContent = "ì—…ë¡œë“œ ì¤‘...";
      submitBtn.disabled = true;

      const title = $("title").value.trim();
      const file  = $("image").files?.[0];

      if (!title) { status.className="status err"; status.textContent="ì œí’ˆëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."; submitBtn.disabled=false; return; }
      if (!file)  { status.className="status err"; status.textContent="ëŒ€í‘œ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”."; submitBtn.disabled=false; return; }

      try {
        const { data: { session } } = await sb.auth.getSession();
        const user = session?.user;
        const email = user?.email;
        const ghUser = user?.user_metadata?.user_name;
        const ok = user && ((email && ADMIN_EMAILS.includes(email)) || (ghUser && ADMIN_USERNAMES.includes(ghUser)));
        if (!ok) { kickLogin(); return; }

        const safeBase = file.name
          .normalize("NFKD")
          .replace(/[^\w.\-]+/g, "_")
          .replace(/^_+|_+$/g, "");
        const mainName = `${Date.now()}_${safeBase}`.replace(/_+/g, "_");
        const mainPath = `product/${mainName}`;

        const { error: upErr } = await sb.storage
          .from(BUCKET)
          .upload(mainPath, file, {
            upsert: false,
            cacheControl: "3600",
            contentType: file.type || "application/octet-stream",
          });
        if (upErr) throw upErr;

        const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(mainPath);
        const image_url = pub.publicUrl;

        const payload = {
          title,
          description: $("desc").value || null,
          material: $("material").value || null,
          usage: $("usage").value || null,
          types: $("types").value || null,
          price: $("price").value ? Number($("price").value) : null,
          image_url,
        };

        const insertResult = await sb
          .from("product")
          .insert(payload)
          .select("id")
          .single();
        if (insertResult.error) throw insertResult.error;

        const productId = insertResult.data.id;

        const extras = imagesInput?.files ? Array.from(imagesInput.files) : [];
        if (extras.length) {
          const baseDir = `product/${productId}`;
          for (const f of extras) {
            const safe = f.name
              .normalize("NFKD")
              .replace(/[^\w.\-]+/g, "_")
              .replace(/^_+|_+$/g, "");
            const name = `${Date.now()}_${safe}`.replace(/_+/g, "_");
            const p = `${baseDir}/${name}`;

            const { error: upErr2 } = await sb.storage
              .from(BUCKET)
              .upload(p, f, {
                upsert: false,
                cacheControl: "3600",
                contentType: f.type || "application/octet-stream",
              });
            if (upErr2) throw upErr2;

            const { data: pub2 } = sb.storage.from(BUCKET).getPublicUrl(p);
            const insImg = await sb.from("product_image").insert({
              product_id: productId,
              url: pub2.publicUrl,
            });
            if (insImg.error) throw insImg.error;
          }
        }

        status.className = "status ok";
        status.textContent = "ë“±ë¡ ì™„ë£Œ!";
      } catch (e) {
        console.error(e);
        status.className = "status err";
        status.textContent = "ë“±ë¡ ì‹¤íŒ¨: " + (e?.message || e);
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>

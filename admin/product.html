<!DOCTYPE html>
<html lang="ko" class="protecting">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>관리자 · 제품 목록</title>
    <script>
  (function enforceWWW(){
    const CANON = "www.eastpowermetal.com";
    if (location.hostname !== CANON) {
      location.replace(`https://${CANON}${location.pathname}${location.search}${location.hash}`);
    }
  })();
  </script>
  <link rel="icon" type="image/png" sizes="32x32" href="/epmFavicon.png">
  <style>
    /* 화면 보호: 인증/화이트리스트 통과 전까지 본문 숨김 */
    html.protecting body { visibility: hidden; }

    :root { --accent:#23585C; --muted:#666; --danger:#C00000; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Nanum Gothic, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; font-size:22px; }
    .topbar { display:flex; gap:10px; align-items:center; margin-bottom:16px; flex-wrap:wrap; }
    .topbar .who { color:var(--muted); }
    .btn { padding:9px 12px; border:0; border-radius:8px; cursor:pointer; background:var(--accent); color:#fff; }
    .btn.ghost { background:#e9ecef; color:#222; }
    .btn.danger { background:var(--danger); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; }
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 800px){ .grid{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .grid{ grid-template-columns: 1fr;} }

    .card { background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); overflow:hidden; display:flex; flex-direction:column; }
    .card img { width:100%; height:200px; object-fit:cover; background:#f2f2f2; }
    .card .info { padding:12px; display:flex; flex-direction:column; gap:6px; }
    .title { font-size:16px; font-weight:700; }
    .muted { color:var(--muted); font-size:12px; }
    .price { color:#111; }
    .actions { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }

    .searchbar { max-width:1200px; margin:0 auto 8px; display:flex; gap:8px; align-items:center; }
    .searchbar input { flex:1; padding:10px 12px; border:1px solid #d0d7de; border-radius:8px; font-size:14px; }

    .pager { display:flex; gap:8px; justify-content:center; align-items:center; padding:16px 0 0; }
    .page-btn{ min-width:38px; height:38px; padding:0 10px; border:1px solid #e3e5e8; background:#fff; border-radius:10px; cursor:pointer; font:14px/38px system-ui; box-shadow:0 1px 4px rgba(0,0,0,.04); }
    .page-btn:hover{ box-shadow:0 2px 10px rgba(0,0,0,.08); }
    .page-btn.active{ background:var(--accent); color:#fff; border-color:var(--accent); font-weight:700; }
    .page-btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .page-ellipsis{ padding:0 6px; color:#888; user-select:none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="topbar">
    <h1>관리자 · 제품 목록</h1>
    <span class="who" id="who">검증 중…</span>
    <span style="flex:1"></span>
    <button class="btn" id="addBtn"  onclick="location.href='https://www.eastpowermetal.com/admin/addProduct.html'">신규 등록</button>
    <button class="btn ghost" id="logoutBtn">로그아웃</button>
  </div>

  <div class="searchbar">
    <input id="q" type="search" placeholder="제품명, 설명, 재질, 용도, 종류 검색">
    <button id="clearBtn" class="btn">초기화</button>
  </div>

  <div id="status" class="muted">로딩 중…</div>
  <div id="grid" class="grid"></div>
  <div id="pager" class="pager"></div>

<script>
/* ===== Supabase/환경설정 ===== */
const SUPABASE_URL = "https://cwwnarmrvpvjptytepdo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3d25hcm1ydnB2anB0eXRlcGRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NzU4NTUsImV4cCI6MjA3NzQ1MTg1NX0.5mvgA_gKdlRaebVRSFIUJRKgp51zke_nffQ2jc8Ad1g";
const BUCKET = "product-image";

/* ===== 관리자 화이트리스트 & 경로 ===== */
const ADMIN_EMAILS = ["chkim.epm@gmail.com"];
const ADMIN_USERNAMES = ["chkim-epm"];
const LOGIN_URL  = "/admin/index.html";   // 미로그인 시
const DENIED_URL = "/admin/denied.html";  // 권한 없음 시

/* ===== Supabase 초기화 ===== */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* URL에 code/access_token이 있을 때만 세션 교환 시도 */
async function ensureSessionFromURL() {
  if (location.search.includes("code=") || location.hash.includes("access_token")) {
    try { await sb.auth.exchangeCodeForSession(window.location.href); } catch(e) {}
  }
}

/* ===== 화면 보호 가드 (인증 + 화이트리스트 통과 시에만 해제) ===== */
async function guardAdmin() {
  const { data: { session } } = await sb.auth.getSession();
  const user = session?.user;
  if (!user) return kickLogin();  // 로그인 안 되어 있으면 로그인 페이지로

  const email = user.email;
  const ghUser = user.user_metadata?.user_name;
  const ok = (email && ADMIN_EMAILS.includes(email)) || (ghUser && ADMIN_USERNAMES.includes(ghUser));
  if (!ok) return kickDenied();    // 화이트리스트 미통과면 denied

  // 통과 → 화면 오픈
  document.getElementById("who").textContent = `관리자: ${email || ghUser}`;
  document.documentElement.classList.remove("protecting");
}

/* ✅ next 파라미터로 원래 경로 전달 (미로그인) */
function kickLogin(){
  const next = encodeURIComponent(location.pathname + location.search);
  location.replace(`${LOGIN_URL}?next=${next}`);
}

/* ✅ 권한 없음은 denied로 */
function kickDenied(){
  location.replace(DENIED_URL);
}

/* 세션 변화에도 동일 가드 재검사 */
sb.auth.onAuthStateChange(() => guardAdmin());

/* ===== 목록/검색/페이지네이션 ===== */
const PAGE_SIZE = 8;
let currentPage = 1;
let currentQuery = "";

const $ = (id)=>document.getElementById(id);
function setStatus(msg){ $("status").textContent = msg || ""; }
function formatPrice(v){ return (v == null || v === "") ? "-" : Number(v).toLocaleString() + " 원"; }

function extractStoragePath(publicUrl){
  try {
    const u = new URL(publicUrl);
    const i = u.pathname.indexOf("/object/public/");
    if (i === -1) return null;
    const rest = u.pathname.substring(i + "/object/public/".length);
    const parts = rest.split("/");
    const bucket = parts.shift();
    if (bucket !== BUCKET) return null;
    return parts.join("/");
  } catch { return null; }
}

async function loadProducts(page=1, q=""){
  currentPage = page; currentQuery = q;
  setStatus("로딩 중…");
  const grid = $("grid"); grid.innerHTML = "";

  const from = (page - 1) * PAGE_SIZE;
  const to   = from + PAGE_SIZE - 1;

  let query = sb.from("product")
                .select("*", { count: "exact" })
                .order("created_at", { ascending:false })
                .range(from, to);

  if (q && q.trim() !== "") {
    const term = q.trim();
    query = query.or(
      `title.ilike.%${term}%,description.ilike.%${term}%,material.ilike.%${term}%,usage.ilike.%${term}%,types.ilike.%${term}%`
    );
  }

  const { data, error, count } = await query;
  if (error){ setStatus("불러오기 실패: " + error.message); console.error(error); return; }
  setStatus(""); renderCards(data||[]); renderPager(count||0, page);
}

function renderCards(items){
  const grid = $("grid");
  if (!items.length){ grid.innerHTML = `<div class="muted">제품이 없습니다.</div>`; return; }
  grid.innerHTML = items.map(p=>{
    const img = p.image_url ? `<img src="${p.image_url}" alt="">` : `<div style="height:200px;background:#f2f2f2"></div>`;
    const price = formatPrice(p.price);
    const created = p.created_at ? new Date(p.created_at).toLocaleString() : "";
    return `
      <div class="card">
        ${img}
        <div class="info">
          <div class="title">${p.title || "-"}</div>
          <div class="price">${price}</div>
          <div class="muted">${created}</div>
          <div class="actions">
            <button class="btn ghost" onclick='location.href="/detail.html?id=${encodeURIComponent(p.id)}"'>상세보기</button>
            <button class="btn ghost" onclick='location.href="/admin/addProduct.html?id=${encodeURIComponent(p.id)}"'>수정</button>
            <button class="btn danger" onclick='deleteProduct(${JSON.stringify(p.id)}, ${JSON.stringify(p.image_url||null)})'>삭제</button>
          </div>
        </div>
      </div>`;
  }).join("");
}

function renderPager(totalCount, page){
  const pager = $("pager");
  const totalPages = Math.max(1, Math.ceil(totalCount / PAGE_SIZE));
  const btn = (p, label=p, {active=false, disabled=false}={}) => `<button class="page-btn ${active?'active':''}" ${disabled?'disabled':''} data-p="${p}">${label}</button>`;
  const dots = `<span class="page-ellipsis">…</span>`;
  const first=1, last=totalPages, left=Math.max(first,page-1), right=Math.min(last,page+1);
  const pages=[]; const push=(x)=>pages.push(x); const addRange=(s,e)=>{ for(let i=s;i<=e;i++) push(i); };
  push(first); if (left>first+1) push("dotsL"); addRange(Math.max(first+1,left), Math.min(last-1,right)); if (right<last-1) push("dotsR"); if (last!==first) push(last);

  let html=''; html+=btn(Math.max(first,page-1),"‹",{disabled:page===first});
  for(const p of pages){ if(p==="dotsL"||p==="dotsR"){ html+=dots; continue; } html+=btn(p,String(p),{active:p===page}); }
  html+=btn(Math.min(last,page+1),"›",{disabled:page===last});
  pager.innerHTML=html;

  pager.onclick=(e)=>{
    const t=e.target;
    if(!t.classList.contains("page-btn")) return;
    const p=Number(t.dataset.p);
    if(!p||p===page) return;
    loadProducts(p,currentQuery);
    window.scrollTo({top:0,behavior:'smooth'});
  };
}

async function deleteProduct(id, image_url){
  const ok = confirm("정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다."); if(!ok) return;
  setStatus("삭제 중…");
  if (image_url) {
    const path = extractStoragePath(image_url);
    if (path) { await sb.storage.from(BUCKET).remove([path]).catch(()=>{}); }
  }
  // (추가 이미지 쓰는 경우 product_image 정리 로직도 여기서 수행)
  const { error } = await sb.from("product").delete().eq("id", id);
  if (error){ setStatus("삭제 실패: " + error.message); return; }
  setStatus("삭제 완료"); await loadProducts(currentPage, currentQuery);
}

/* 검색 이벤트 */
const qInput = $("q"), clearBtn=$("clearBtn");
function debounce(fn,ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
if (qInput) qInput.addEventListener("input", debounce(()=>loadProducts(1, qInput.value), 300));
if (clearBtn) clearBtn.addEventListener("click", ()=>{ if(!qInput) return; qInput.value=""; loadProducts(1,""); });

/* 로그아웃 */
$("logoutBtn").addEventListener("click", async ()=>{ await sb.auth.signOut(); location.replace(LOGIN_URL); });

/* ===== 시작: 세션 교환 → 가드 → 데이터 로드 ===== */
(async function init(){
  await ensureSessionFromURL();   // ① URL의 code/access_token 처리
  await guardAdmin();             // ② 통과 시 보호 해제
  await loadProducts(1, "");      // ③ 목록 로드
  setTimeout(() => {
    const grid = $("grid");
    if (grid && grid.innerText.trim() === "") {
      setStatus("시간 초과: 네트워크/권한 문제일 수 있습니다. 콘솔/네트워크 로그 확인 바랍니다.");
    }
  }, 8000);
})();
</script>
</body>
</html>


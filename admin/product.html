<!DOCTYPE html>
<html lang="ko" class="protecting">
<head>
  <meta charset="utf-8" />
  <!-- ✅ 반응형: 모바일/태블릿/데스크톱에서 적절한 스케일 유지 -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ⚠️ admin 영역은 검색 노출 금지 -->
  <meta name="robots" content="noindex,nofollow" />
  <title>관리자 · 제품 목록</title>
  
  <script>
    /* =========================================================================
       0) www 정규화 (세션 오리진 통일)
       - 인증 쿠키/토큰은 오리진(프로토콜+호스트+포트)에 종속됨
       - www가 아닌 도메인으로 접속 시, 동일 경로/쿼리/해시를 보존하여
         https://www.eastpowermetal.com 으로 강제 이동
       - 목적: OAuth Redirect/세션 일관성, CORS 혼선 예방
       ========================================================================= */
    (function enforceWWW() {
      const CANON = "www.eastpowermetal.com";
      const allowed = [CANON, "eastpowermetal.com"];
      if (allowed.includes(location.hostname) && location.hostname !== CANON) {
        location.replace(`https://${CANON}${location.pathname}${location.search}${location.hash}`);
      }
    })();
  </script>
  
  <!-- 파비콘 (브라우저 탭 아이콘) -->
  <link rel="icon" type="image/png" sizes="32x32" href="/epmFavicon.png">

  <style>
    /* =========================================================================
       기본 스타일 및 화면 보호
       - protecting 클래스가 html 요소에 있을 동안 body를 숨겨
         '인증/화이트리스트' 완료 전 내용 노출을 방지
       - CSS 변수로 주요 색상을 관리
       ========================================================================= */

    /* 화면 보호: 인증/화이트리스트 통과 전까지 본문 숨김 */
    html.protecting body { visibility: hidden; }

    :root { --accent:#23585C; --muted:#666; --danger:#C00000; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Nanum Gothic, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; font-size:22px; }

    /* 상단 바: 타이틀/유저/버튼 영역 */
    .topbar { display:flex; gap:10px; align-items:center; margin-bottom:16px; flex-wrap:wrap; }
    .topbar .who { color:var(--muted); }

    /* 공통 버튼 스타일 */
    .btn { padding:9px 12px; border:0; border-radius:8px; cursor:pointer; background:var(--accent); color:#fff; }
    .btn.ghost { background:#e9ecef; color:#222; }
    .btn.danger { background:var(--danger); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    /* 카드 그리드 레이아웃 (반응형 4→3→2→1열) */
    .grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; }
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 800px){ .grid{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .grid{ grid-template-columns: 1fr;} }

    /* 제품 카드 */
    .card { background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); overflow:hidden; display:flex; flex-direction:column; }
    .card img { width:100%; height:200px; object-fit:cover; background:#f2f2f2; }
    .card .info { padding:12px; display:flex; flex-direction:column; gap:6px; }
    .title { font-size:16px; font-weight:700; }
    .muted { color:var(--muted); font-size:12px; }
    .price { color:#111; }
    .actions { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }

    /* 검색 입력창 */
    .searchbar { max-width:1200px; margin:0 auto 8px; display:flex; gap:8px; align-items:center; }
    .searchbar input { flex:1; padding:10px 12px; border:1px solid #d0d7de; border-radius:8px; font-size:14px; }

    /* 페이지네이션 버튼 */
    .pager { display:flex; gap:8px; justify-content:center; align-items:center; padding:16px 0 0; }
    .page-btn{ min-width:38px; height:38px; padding:0 10px; border:1px solid #e3e5e8; background:#fff; border-radius:10px; cursor:pointer; font:14px/38px system-ui; box-shadow:0 1px 4px rgba(0,0,0,.04); }
    .page-btn:hover{ box-shadow:0 2px 10px rgba(0,0,0,.08); }
    .page-btn.active{ background:var(--accent); color:#fff; border-color:var(--accent); font-weight:700; }
    .page-btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .page-ellipsis{ padding:0 6px; color:#888; user-select:none; }
  </style>

  <!-- Supabase JS SDK v2: 인증/DB/스토리지 브라우저 클라이언트 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- 상단 바: 제목, 로그인 사용자 표시, 우측에 동작 버튼 -->
  <div class="topbar">
    <h1>관리자 · 제품 목록</h1>
    <span class="who" id="who">검증 중…</span>
    <span style="flex:1"></span>
    <!-- 신규 등록: 관리자 상품 작성 페이지로 이동 -->
    <button class="btn" id="addBtn" onclick="location.href='/admin/addProduct.html'">신규 등록</button>
    <!-- 로그아웃 버튼 -->
    <button class="btn ghost" id="logoutBtn">로그아웃</button>
  </div>

  <!-- 검색 영역: 제품명/설명/재질/용도/종류 키워드 검색, 초기화 버튼 -->
  <div class="searchbar">
    <input id="q" type="search" placeholder="제품명, 설명, 재질, 용도, 종류 검색">
    <button id="clearBtn" class="btn">초기화</button>
  </div>

  <!-- 상태 메시지 (로딩/오류/결과 없음 등) -->
  <div id="status" class="muted">로딩 중…</div>
  <!-- 카드 그리드 출력 컨테이너 -->
  <div id="grid" class="grid"></div>
  <!-- 페이지네이션 출력 컨테이너 -->
  <div id="pager" class="pager"></div>

<script>
const SUPABASE_URL = "https://cwwnarmrvpvjptytepdo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3d25hcm1ydnB2anB0eXRlcGRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NzU4NTUsImV4cCI6MjA3NzQ1MTg1NX0.5mvgA_gKdlRaebVRSFIUJRKgp51zke_nffQ2jc8Ad1g";
const BUCKET = "product-image";

const ADMIN_EMAILS = ["chkim.epm@gmail.com"];
const ADMIN_USERNAMES = ["chkim-epm"];
const LOGIN_URL  = "/admin/index.html";
const DENIED_URL = "/admin/denied.html";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function ensureSessionFromURL() {
  if (location.search.includes("code=") || location.hash.includes("access_token")) {
    try { await sb.auth.exchangeCodeForSession(window.location.href); } catch(e) {}
  }
}

async function guardAdmin() {
  const { data: { session } } = await sb.auth.getSession();
  const user = session?.user;
  if (!user) return kickLogin();

  const email = user.email;
  const ghUser = user.user_metadata?.user_name;
  const ok = (email && ADMIN_EMAILS.includes(email)) || (ghUser && ADMIN_USERNAMES.includes(ghUser));
  if (!ok) return kickDenied();

  document.getElementById("who").textContent = `관리자: ${email || ghUser}`;
  document.documentElement.classList.remove("protecting");
}

function kickLogin(){
  const next = encodeURIComponent(location.pathname + location.search + location.hash);
  location.replace(`${LOGIN_URL}?next=${next}`);
}

function kickDenied(){
  location.replace(DENIED_URL);
}

setTimeout(() => {
  if (document.documentElement.classList.contains('protecting')) {
    kickLogin();
  }
}, 5000);

sb.auth.onAuthStateChange(() => guardAdmin());

/* 이하 나머지 코드는 원본 그대로 유지됨 */
</script>
</body>
</html>

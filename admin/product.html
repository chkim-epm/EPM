<!DOCTYPE html>
<html lang="ko" class="protecting">
<head>
  <meta charset="utf-8" />
  <!-- ✅ 반응형: 모바일/태블릿/데스크톱에서 적절한 스케일 유지 -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ⚠️ admin 영역은 검색 노출 금지 -->
  <meta name="robots" content="noindex,nofollow" />
  <title>관리자 · 제품 목록</title>
  
  <script>
    /* =========================================================================
       0) www 정규화 (세션 오리진 통일)
       - 인증 쿠키/토큰은 오리진(프로토콜+호스트+포트)에 종속됨
       - www가 아닌 도메인으로 접속 시, 동일 경로/쿼리/해시를 보존하여
         https://www.eastpowermetal.com 으로 강제 이동
       - 목적: OAuth Redirect/세션 일관성, CORS 혼선 예방
       ========================================================================= */
(function enforceWWW() {
  const CANON = "www.eastpowermetal.com";
  const allowed = [CANON, "eastpowermetal.com"];
  if (allowed.includes(location.hostname) && location.hostname !== CANON) {
    location.replace(`https://${CANON}${location.pathname}${location.search}${location.hash}`);
  }
})();

  </script>
  
  <!-- 파비콘 (브라우저 탭 아이콘) -->
  <link rel="icon" type="image/png" sizes="32x32" href="/epmFavicon.png">

  <style>
    /* =========================================================================
       기본 스타일 및 화면 보호
       - protecting 클래스가 html 요소에 있을 동안 body를 숨겨
         '인증/화이트리스트' 완료 전 내용 노출을 방지
       - CSS 변수로 주요 색상을 관리
       ========================================================================= */

    /* 화면 보호: 인증/화이트리스트 통과 전까지 본문 숨김 */
    html.protecting body { visibility: hidden; }

    :root { --accent:#23585C; --muted:#666; --danger:#C00000; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Nanum Gothic, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; font-size:22px; }

    /* 상단 바: 타이틀/유저/버튼 영역 */
    .topbar { display:flex; gap:10px; align-items:center; margin-bottom:16px; flex-wrap:wrap; }
    .topbar .who { color:var(--muted); }

    /* 공통 버튼 스타일 */
    .btn { padding:9px 12px; border:0; border-radius:8px; cursor:pointer; background:var(--accent); color:#fff; }
    .btn.ghost { background:#e9ecef; color:#222; }
    .btn.danger { background:var(--danger); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    /* 카드 그리드 레이아웃 (반응형 4→3→2→1열) */
    .grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; }
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 800px){ .grid{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .grid{ grid-template-columns: 1fr;} }

    /* 제품 카드 */
    .card { background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); overflow:hidden; display:flex; flex-direction:column; }
    .card img { width:100%; height:200px; object-fit:cover; background:#f2f2f2; }
    .card .info { padding:12px; display:flex; flex-direction:column; gap:6px; }
    .title { font-size:16px; font-weight:700; }
    .muted { color:var(--muted); font-size:12px; }
    .price { color:#111; }
    .actions { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }

    /* 검색 입력창 */
    .searchbar { max-width:1200px; margin:0 auto 8px; display:flex; gap:8px; align-items:center; }
    .searchbar input { flex:1; padding:10px 12px; border:1px solid #d0d7de; border-radius:8px; font-size:14px; }

    /* 페이지네이션 버튼 */
    .pager { display:flex; gap:8px; justify-content:center; align-items:center; padding:16px 0 0; }
    .page-btn{ min-width:38px; height:38px; padding:0 10px; border:1px solid #e3e5e8; background:#fff; border-radius:10px; cursor:pointer; font:14px/38px system-ui; box-shadow:0 1px 4px rgba(0,0,0,.04); }
    .page-btn:hover{ box-shadow:0 2px 10px rgba(0,0,0,.08); }
    .page-btn.active{ background:var(--accent); color:#fff; border-color:var(--accent); font-weight:700; }
    .page-btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .page-ellipsis{ padding:0 6px; color:#888; user-select:none; }
  </style>

  <!-- Supabase JS SDK v2: 인증/DB/스토리지 브라우저 클라이언트 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- 상단 바: 제목, 로그인 사용자 표시, 우측에 동작 버튼 -->
  <div class="topbar">
    <h1>관리자 · 제품 목록</h1>
    <span class="who" id="who">검증 중…</span>
    <span style="flex:1"></span>
    <!-- 신규 등록: 관리자 상품 작성 페이지로 이동 -->
    <button class="btn" id="addBtn" onclick="location.href='/admin/addProduct.html'">신규 등록</button>
    <!-- 로그아웃 버튼 -->
    <button class="btn ghost" id="logoutBtn">로그아웃</button>
  </div>

  <!-- 검색 영역: 제품명/설명/재질/용도/종류 키워드 검색, 초기화 버튼 -->
  <div class="searchbar">
    <input id="q" type="search" placeholder="제품명, 설명, 재질, 용도, 종류 검색">
    <button id="clearBtn" class="btn">초기화</button>
  </div>

  <!-- 상태 메시지 (로딩/오류/결과 없음 등) -->
  <div id="status" class="muted">로딩 중…</div>
  <!-- 카드 그리드 출력 컨테이너 -->
  <div id="grid" class="grid"></div>
  <!-- 페이지네이션 출력 컨테이너 -->
  <div id="pager" class="pager"></div>

<script>
  console.log("product script start");

/* ============================================================================
   Supabase/환경상수
   - URL/anon key: 프로젝트 연결 정보
   - BUCKET: 이미지가 저장되는 스토리지 버킷명
   ============================================================================ */
const SUPABASE_URL = "https://cwwnarmrvpvjptytepdo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3d25hcm1ydnB2anB0eXRlcGRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NzU4NTUsImV4cCI6MjA3NzQ1MTg1NX0.5mvgA_gKdlRaebVRSFIUJRKgp51zke_nffQ2jc8Ad1g";
const BUCKET = "product-image";
console.log("test1");

/* ============================================================================
   관리자 화이트리스트 & 경로
   - GitHub OAuth 후 user.email 또는 user_metadata.user_name를 기준으로 허용
   - LOGIN_URL: 미로그인 시 보낼 로그인 페이지
   - DENIED_URL: 로그인은 했으나 권한 없는 계정에 대한 차단 페이지
   ============================================================================ */
const ADMIN_EMAILS = ["chkim.epm@gmail.com"];
const ADMIN_USERNAMES = ["chkim-epm"];
const LOGIN_URL  = "/admin/index.html";   // 미로그인 시
const DENIED_URL = "/admin/denied.html";  // 권한 없음 시

  console.log("test2");


/* ============================================================================
   Supabase 초기화: 브라우저 클라이언트 인스턴스 생성
   ============================================================================ */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {          // ✅ 변경: index와 동일하게 세션 저장/공유 옵션 명시
  auth: {                                                                    // ✅ 변경
    persistSession: true,                                                    // ✅ 변경
    autoRefreshToken: true,                                                  // ✅ 변경
    detectSessionInUrl: true,                                                // ✅ 변경
    storage: window.localStorage,                                            // ✅ 변경
    storageKey: 'epm-admin-auth'                                             // ✅ 변경
  }                                                                          // ✅ 변경
});                                                                          // ✅ 변경
console.log("test3");

/* ============================================================================
   OAuth 리디렉션 직후 세션 교환 처리
   - Supabase OAuth는 리다이렉트 시 URL에 code 또는 해시 토큰을 첨부
   - 해당 토큰을 세션으로 교환하여 현재 탭에 로그인 상태를 확립
   ============================================================================ */
async function ensureSessionFromURL() {
  // detectSessionInUrl 옵션이 자동으로 세션 교환 처리
  // 여기서는 URL에 남은 code/access_token 흔적만 제거
  if (location.search.includes("code=") || location.hash.includes("access_token")) {
    history.replaceState({}, document.title, location.pathname);
  }
}

console.log("test4");

/* ============================================================================
   화면 보호 가드 (인증 + 화이트리스트 확인)
   1) 세션 조회 → user 없으면 로그인 페이지로 보냄
   2) 이메일/깃허브 사용자명 화이트리스트 검사
   3) 통과 시 protecting 해제 → 본문 표시
   ============================================================================ */
async function guardAdmin() {
  console.log("test44");
  console.log("[guard] entered"); // ✅ 디버그
  
let session;
  try { // ✅ 변경: getSession 예외/멈춤 확인
      console.log("[guard] before getSession"); // ✅ 추가
    const res = await sb.auth.getSession();
    console.log("[guard] after getSession", res); // ✅ 추가
    session = res?.data?.session;
    console.log("[guard] session:", session); // ✅ 변경
  } catch (e) {
    console.error("[guard] getSession error:", e); // ✅ 변경
    // ✅ 변경: 흰 화면 방지(원인 확인용으로 잠깐 화면 열기)
    document.documentElement.classList.remove("protecting");
    setStatus("getSession 오류: " + (e?.message || e));
    return;
  }

  
  
  const user = session?.user;
  if (!user) {
    console.log("[guard] no user -> kickLogin"); // ✅ 디버그
    return kickLogin();
  }
  const email = user.email;
  const ghUser = user.user_metadata?.user_name;
  console.log("[guard] email:", email, "ghUser:", ghUser); // ✅ 디버그
  const ok =
    (email && ADMIN_EMAILS.includes(email)) ||
    (ghUser && ADMIN_USERNAMES.includes(ghUser));
  if (!ok) {
    console.log("[guard] not allowed -> kickDenied"); // ✅ 디버그
    return kickDenied();
  }
  // 통과 → 화면 오픈 및 상단에 사용자 표시
  document.getElementById("who").textContent = `관리자: ${email || ghUser}`;
  document.documentElement.classList.remove("protecting");
}

  console.log("test5");


/* ============================================================================
   미로그인 처리
   - 현재 위치를 next 파라미터로 전달하여 로그인 후 원래 페이지로 복귀 가능
   ============================================================================ */
function kickLogin(){
  const next = encodeURIComponent(location.pathname + location.search + location.hash);
  location.replace(`${LOGIN_URL}?next=${next}`);
}
console.log("test6");

/* ============================================================================
   권한 없음 처리
   - 로그인은 했지만 화이트리스트 미통과 계정 → denied 페이지
   ============================================================================ */
function kickDenied(){
  location.replace(DENIED_URL);
}
console.log("test7");

/* ============================================================================
   세션 상태 변화 대응
   - 다른 탭/창에서 로그인/로그아웃 시에도 현재 페이지 가드 재평가
   ============================================================================ */
sb.auth.onAuthStateChange(() => guardAdmin());
console.log("test8");

/* ============================================================================
   목록/검색/페이지네이션 로직
   - PAGE_SIZE: 페이지당 카드 수
   - loadProducts: DB에서 product 테이블을 범위 조회(+검색어 조건)
   - renderCards: 카드 UI 렌더링
   - renderPager: 페이지 버튼 렌더링 + 클릭 핸들러
   ============================================================================ */
const PAGE_SIZE = 8;
let currentPage = 1;
let currentQuery = "";

/* DOM 헬퍼/상태 표시/가격 포맷 */
const $ = (id)=>document.getElementById(id);
function setStatus(msg){ $("status").textContent = msg || ""; }
function formatPrice(v){ return (v == null || v === "") ? "-" : Number(v).toLocaleString() + " 원"; }
console.log("test9");

/* ============================================================================
   스토리지 public URL → 내부 경로(path) 추출
   - 삭제 시 sb.storage.remove()는 '버킷 내 경로'가 필요함
   - 공개 URL에서 /object/public/{bucket}/{path} 형태를 파싱하여 path 반환
   ============================================================================ */
function extractStoragePath(publicUrl){
  try {
    const u = new URL(publicUrl);
    const i = u.pathname.indexOf("/object/public/");
    if (i === -1) return null;
    const rest = u.pathname.substring(i + "/object/public/".length);
    const parts = rest.split("/");
    const bucket = parts.shift();
    if (bucket !== BUCKET) return null;
    return parts.join("/");
  } catch { return null; }
}
console.log("test10");


/* ============================================================================
   제품 목록 불러오기
   - 페이지 범위(from~to) 계산 후 select + count 요청
   - 검색어가 있으면 title/description/material/usage/types에 부분일치(ilike) OR 조건
   - 최신(created_at desc) 우선으로 정렬
   ============================================================================ */
async function loadProducts(page=1, q=""){
  currentPage = page; currentQuery = q;
  setStatus("로딩 중…");
  const grid = $("grid"); grid.innerHTML = "";

  const from = (page - 1) * PAGE_SIZE;
  const to   = from + PAGE_SIZE - 1;

  let query = sb.from("product")
                .select("*", { count: "exact" })
                .order("created_at", { ascending:false })
                .range(from, to);

  if (q && q.trim() !== "") {
    const term = q.trim();
    // 여러 컬럼에 대해 부분 일치 검색(대소문자 무시)
    query = query.or(
      `title.ilike.%${term}%,description.ilike.%${term}%,material.ilike.%${term}%,usage.ilike.%${term}%,types.ilike.%${term}%`
    );
  }

  const { data, error, count } = await query;
  if (error){ setStatus("불러오기 실패: " + error.message); console.error(error); return; }
  setStatus(""); renderCards(data||[]); renderPager(count||0, page);
}
  console.log("test11");

/* ============================================================================
   카드 렌더링
   - 이미지 URL이 없으면 회색 박스로 대체
   - 가격/작성일 포맷
   - 상세보기(퍼블릭 페이지), 수정(관리자 페이지), 삭제 버튼 제공
   ============================================================================ */
function renderCards(items){
  const grid = $("grid");
  if (!items.length){ grid.innerHTML = `<div class="muted">제품이 없습니다.</div>`; return; }
  grid.innerHTML = items.map(p=>{
    const img = p.image_url ? `<img src="${p.image_url}" alt="">` : `<div style="height:200px;background:#f2f2f2"></div>`;
    const price = formatPrice(p.price);
    const created = p.created_at ? new Date(p.created_at).toLocaleString() : "";
    return `
      <div class="card">
        ${img}
        <div class="info">
          <div class="title">${p.title || "-"}</div>
          <div class="price">${price}</div>
          <div class="muted">${created}</div>
          <div class="actions">
            <button class="btn ghost" onclick='location.href="/detail.html?id=${encodeURIComponent(p.id)}"'>상세보기</button>
            <button class="btn ghost" onclick='location.href="/admin/addProduct.html?id=${encodeURIComponent(p.id)}"'>수정</button>
            <button class="btn danger" onclick='deleteProduct(${JSON.stringify(p.id)}, ${JSON.stringify(p.image_url||null)})'>삭제</button>
          </div>
        </div>
      </div>`;
  }).join("");
}
console.log("test12");
/* ============================================================================
   페이지네이션 렌더링
   - 현재 페이지 기준 좌우 한 칸씩 노출 + 처음/끝은 항상 표시
   - 중간에 범위가 넓으면 …(ellipsis) 삽입
   - 버튼 클릭 시 해당 페이지로 재조회 + 스크롤 업
   ============================================================================ */
function renderPager(totalCount, page){
  const pager = $("pager");
  const totalPages = Math.max(1, Math.ceil(totalCount / PAGE_SIZE));
  const btn = (p, label=p, {active=false, disabled=false}={}) => `<button class="page-btn ${active?'active':''}" ${disabled?'disabled':''} data-p="${p}">${label}</button>`;
  const dots = `<span class="page-ellipsis">…</span>`;
  const first=1, last=totalPages, left=Math.max(first,page-1), right=Math.min(last,page+1);
  const pages=[]; const push=(x)=>pages.push(x); const addRange=(s,e)=>{ for(let i=s;i<=e;i++) push(i); };
  push(first); if (left>first+1) push("dotsL"); addRange(Math.max(first+1,left), Math.min(last-1,right)); if (right<last-1) push("dotsR"); if (last!==first) push(last);

  let html=''; html+=btn(Math.max(first,page-1),"‹",{disabled:page===first});
  for(const p of pages){ if(p==="dotsL"||p==="dotsR"){ html+=dots; continue; } html+=btn(p,String(p),{active:p===page}); }
  html+=btn(Math.min(last,page+1),"›",{disabled:page===last});
  pager.innerHTML=html;

  pager.onclick=(e)=>{
    const t=e.target;
    if(!t.classList.contains("page-btn")) return;
    const p=Number(t.dataset.p);
    if(!p||p===page) return;
    loadProducts(p,currentQuery);
    window.scrollTo({top:0,behavior:'smooth'});
  };
}
console.log("test13");
/* ============================================================================
   삭제 처리
   - 1) 확인 다이얼로그
   - 2) 대표 이미지가 있으면 public URL → 스토리지 경로를 추출해 remove
   - 3) product 행 삭제
   - 4) 현재 페이지 재조회
   - ※ 추가 이미지가 별도 테이블(product_image 등)로 관리되면 그 정리 로직도 추가
   ============================================================================ */
async function deleteProduct(id, image_url){
  const ok = confirm("정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다."); if(!ok) return;
  setStatus("삭제 중…");
  if (image_url) {
    const path = extractStoragePath(image_url);
    if (path) { await sb.storage.from(BUCKET).remove([path]).catch(()=>{}); }
  }
  // (추가 이미지 쓰는 경우 product_image 정리 로직도 여기서 수행)
  const { error } = await sb.from("product").delete().eq("id", id);
  if (error){ setStatus("삭제 실패: " + error.message); return; }
  setStatus("삭제 완료"); await loadProducts(currentPage, currentQuery);
}
console.log("test14");
/* ============================================================================
   검색 이벤트
   - 입력 지연(debounce) 300ms 후 조회
   - 초기화 버튼: 검색어 비우고 첫 페이지 재조회
   ============================================================================ */
const qInput = $("q"), clearBtn=$("clearBtn");
function debounce(fn,ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
if (qInput) qInput.addEventListener("input", debounce(()=>loadProducts(1, qInput.value), 300));
if (clearBtn) clearBtn.addEventListener("click", ()=>{ if(!qInput) return; qInput.value=""; loadProducts(1,""); });
console.log("test15");
/* ============================================================================
   로그아웃
   - Supabase 세션 해제 후 로그인 페이지로 이동(복귀 경로는 index에서 처리)
   ============================================================================ */
$("logoutBtn").addEventListener("click", async ()=>{ await sb.auth.signOut(); location.replace(LOGIN_URL); });
console.log("test16");
/* ============================================================================
   초기 구동 시퀀스
   ① ensureSessionFromURL: OAuth code/hash → 세션 교환
   ② guardAdmin: 인증/화이트리스트 확인 후 보호 해제
   ③ loadProducts: 첫 페이지 로드
   ④ 타임아웃 가드: 8초 내 그리드 텍스트가 비어 있으면 안내 메시지 표기
   ============================================================================ */
(async function init(){
  try { // ✅ 디버그용(흰 화면 방지)
    console.log("[init] start"); // ✅ 디버그: init 실행 확인
    await ensureSessionFromURL();
    await guardAdmin();
    await loadProducts(1, "");
    setTimeout(() => {
      const grid = $("grid");
      if (grid && grid.innerText.trim() === "") {
        setStatus("시간 초과: 네트워크/권한 문제일 수 있습니다. 콘솔/네트워크 로그 확인 바랍니다.");
      }
    }, 8000);
  } catch (e) { // ✅ 디버그용
    console.error(e);
    document.documentElement.classList.remove("protecting"); // ✅ 화면 열기
    setStatus("스크립트 오류: " + (e?.message || e));
  }
})();

</script>
</body>
</html>











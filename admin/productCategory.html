<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>상품 카테고리 관리</title>
<style>
  :root { --bd:#e5e7eb; --txt:#111827; --mut:#6b7280; }
  body { font-family: Arial,"Malgun Gothic",sans-serif; margin:24px; color:var(--txt);}
  .wrap { max-width:1100px; margin:0 auto; }
  h1 { margin:0 0 10px; }
  .muted { color:var(--mut); font-size:12px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .box { border:1px solid var(--bd); border-radius:12px; padding:14px; margin-top:12px; }
  label{ display:block; font-size:13px; margin:10px 0 6px;}
  input,select,textarea{ width:100%; padding:10px; border:1px solid #d1d5db; border-radius:10px;}
  textarea{min-height:90px;}
  .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
  @media(max-width:900px){.grid{grid-template-columns:1fr;}}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer;}
  .btn.secondary{background:#fff;color:#111;}
  .btn.danger{background:#b91c1c;border-color:#b91c1c;}
  table{width:100%;border-collapse:collapse;margin-top:10px;}
  th,td{border-bottom:1px solid var(--bd);padding:10px;font-size:13px;}
  th{background:#fafafa;}
  .pill{padding:2px 10px;border-radius:999px;background:#f3f4f6;font-size:12px;}
  .mono{font-family:monospace;}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;}
  .modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    background:#fff;border:1px solid var(--bd);border-radius:14px;padding:14px;display:none;width:min(720px,92vw);}
</style>
</head>

<body>
<div class="wrap">
<h1>상품 카테고리 관리</h1>
<div class="muted">Supabase 연결 버전</div>

<div class="box">
  <div class="row">
    <input id="q" placeholder="검색">
    <select id="useFilter">
      <option value="">사용여부(전체)</option>
      <option value="Y">사용</option>
      <option value="N">미사용</option>
    </select>
    <button class="btn secondary" id="reloadBtn">새로고침</button>
    <button class="btn" id="addBtn">+ 카테고리 추가</button>
    <span id="countTxt" class="muted"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th>CategoryKey</th>
        <th>카테고리명</th>
        <th>정렬</th>
        <th>사용</th>
        <th>관리</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>
</div>

<div class="modal-backdrop" id="backdrop"></div>
<div class="modal" id="modal">
<h3 id="modalTitle"></h3>
<form id="form">
  <div class="grid">
    <div>
      <label>CategoryKey</label>
      <input id="CategoryKey" class="mono" required />
    </div>
    <div>
      <label>카테고리명</label>
      <input id="CategoryName" required />
    </div>
    <div>
      <label>정렬순서</label>
      <input id="SortOrder" type="number" />
    </div>
  </div>

  <label>사용여부</label>
  <select id="UseYn">
    <option value="Y">Y</option>
    <option value="N">N</option>
  </select>

  <label>비고</label>
  <textarea id="Remark"></textarea>

  <br><br>
  <button class="btn" type="submit" id="saveBtn">저장</button>
  <button class="btn secondary" type="button" id="cancelBtn">취소</button>
  <button class="btn danger" type="button" id="deleteBtn" style="display:none;">삭제</button>
</form>
</div>

<script>
/* =========================
   ✅ Supabase 설정
========================= */
const SUPABASE_URL = "https://cwwnarmrvpvjptytepdo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3d25hcm1ydnB2anB0eXRlcGRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NzU4NTUsImV4cCI6MjA3NzQ1MTg1NX0.5mvgA_gKdlRaebVRSFIUJRKgp51zke_nffQ2jc8Ad1g";

// 실제 테이블명 (스샷 기준)
const API_BASE = `${SUPABASE_URL}/rest/v1/productcategory`;

const headers = {
  "apikey": SUPABASE_ANON_KEY,
  "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
  "Content-Type": "application/json",
  "Accept": "application/json"
};

let rows = [];
let editingId = null;
const $ = id => document.getElementById(id);

/* ========================= */

async function load(){
  $("reloadBtn").disabled = true;
  const res = await fetch(`${API_BASE}?select=*&order=sort_order.asc`, { headers });
  if(!res.ok){ alert("조회 실패 : " + res.status); return; }
  const data = await res.json();

  rows = data.map(x => ({
    id:x.id,
    categoryKey:x.category_key,
    categoryName:x.category_name,
    sortOrder:x.sort_order,
    useYn:x.use_yn,
    remark:x.remark
  }));
  render();
  $("reloadBtn").disabled = false;
}

function render(){
  const tbody = $("tbody");
  tbody.innerHTML = "";
  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${r.categoryKey}</td>
      <td>${r.categoryName}</td>
      <td>${r.sortOrder}</td>
      <td><span class="pill">${r.useYn}</span></td>
      <td>
        <button class="btn secondary" onclick="editRow(${r.id})">수정</button>
        <button class="btn danger" onclick="deleteRow(${r.id})">삭제</button>
      </td>`;
    tbody.appendChild(tr);
  });
  $("countTxt").textContent = rows.length+"건";
}

function openModal(){
  $("modalTitle").innerText = editingId ? "카테고리 수정" : "카테고리 추가";
  $("backdrop").style.display="block";
  $("modal").style.display="block";
}

function closeModal(){
  $("backdrop").style.display="none";
  $("modal").style.display="none";
  editingId=null;
  $("form").reset();
}

$("addBtn").onclick = ()=>{ editingId=null; openModal(); };
$("cancelBtn").onclick = closeModal;

window.editRow = (id)=>{
  const r = rows.find(x=>x.id==id);
  editingId = id;
  $("CategoryKey").value = r.categoryKey;
  $("CategoryKey").disabled = true;
  $("CategoryName").value = r.categoryName;
  $("SortOrder").value = r.sortOrder;
  $("UseYn").value = r.useYn;
  $("Remark").value = r.remark || "";
  openModal();
};

window.deleteRow = async(id)=>{
  if(!confirm("삭제할까요?")) return;
  await fetch(`${API_BASE}?id=eq.${id}`, { method:"DELETE", headers });
  load();
};

$("form").onsubmit = async(e)=>{
  e.preventDefault();

  const body = {
    category_key: $("CategoryKey").value.trim(),
    category_name: $("CategoryName").value.trim(),
    sort_order: Number($("SortOrder").value||0),
    use_yn: $("UseYn").value,
    remark: $("Remark").value.trim()
  };

  if(editingId){
    await fetch(`${API_BASE}?id=eq.${editingId}`, {
      method:"PATCH", headers, body:JSON.stringify(body)
    });
  }else{
    await fetch(API_BASE,{
      method:"POST", headers, body:JSON.stringify(body)
    });
  }

  closeModal();
  load();
};

load();
</script>
</body>
</html>

<!doctype html>
<html lang="ko" class="protecting">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="robots" content="noindex,nofollow" />

<title>상품 카테고리 관리</title>

<script>
/* =========================================================================
   www 정규화 (admin/product 와 동일)
   ========================================================================= */
(function enforceWWW() {
  const CANON = "www.eastpowermetal.com";
  const allowed = [CANON, "eastpowermetal.com"];
  if (allowed.includes(location.hostname) && location.hostname !== CANON) {
    location.replace(`https://${CANON}${location.pathname}${location.search}${location.hash}`);
  }
})();
</script>

<style>
/* ✅ 인증 전 화면 숨김 (admin/product 와 동일) */
html.protecting body { visibility:hidden; }

:root { --bd:#e5e7eb; --txt:#111827; --mut:#6b7280; }
body { font-family: Arial,"Malgun Gothic",sans-serif; margin:24px; color:var(--txt);}
.wrap { max-width:1100px; margin:0 auto; }
h1 { margin:0 0 10px; }
.muted { color:var(--mut); font-size:12px; }
.row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.box { border:1px solid var(--bd); border-radius:12px; padding:14px; margin-top:12px; }
label{ display:block; font-size:13px; margin:10px 0 6px;}
input,select,textarea{ width:100%; padding:10px; border:1px solid #d1d5db; border-radius:10px;}
textarea{min-height:90px;}
.grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
@media(max-width:900px){.grid{grid-template-columns:1fr;}}
.btn{padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer;}
.btn.secondary{background:#fff;color:#111;}
.btn.danger{background:#b91c1c;border-color:#b91c1c;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border-bottom:1px solid var(--bd);padding:10px;font-size:13px;}
th{background:#fafafa;}
.pill{padding:2px 10px;border-radius:999px;background:#f3f4f6;font-size:12px;}
.mono{font-family:monospace;}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;}
.modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
background:#fff;border:1px solid var(--bd);border-radius:14px;padding:14px;display:none;width:min(720px,92vw);}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* =========================================================================
   관리자 접근 가드 (admin/product 와 100% 동일 패턴)
   ========================================================================= */

const ADMIN_EMAILS   = ["chkim.epm@gmail.com"];
const ADMIN_USERNAMES = ["chkim-epm"];

const LOGIN_URL  = "/admin/index.html";
const DENIED_URL = "/admin/denied.html";

const SUPABASE_URL = "https://cwwnarmrvpvjptytepdo.supabase.co";

/* ⚠️ admin/product 와 같은 anon key */
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3d25hcm1ydnB2anB0eXRlcGRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NzU4NTUsImV4cCI6MjA3NzQ1MTg1NX0.5mvgA_gKdlRaebVRSFIUJRKgp51zke_nffQ2jc8Ad1g";

/* cookie storage (admin/product 그대로) */
const cookieStorage = (() => {
  const CHUNK_SIZE = 3000;
  const OPTS = "path=/; SameSite=Lax; Domain=.eastpowermetal.com";

  const getCookie = (name) => {
    const m = document.cookie.match(
      new RegExp("(^| )" + name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&") + "=([^;]+)")
    );
    return m ? decodeURIComponent(m[2]) : null;
  };

  const setCookie = (name, value) => {
    document.cookie = `${name}=${encodeURIComponent(value)}; ${OPTS}`;
  };

  const delCookie = (name) => {
    document.cookie = `${name}=; Max-Age=0; path=/; Domain=.eastpowermetal.com`;
  };

  return {
    getItem: (key) => {
      const meta = getCookie(`${key}.__chunks`);
      if (!meta) return getCookie(key);
      const n = Number(meta);
      if (!Number.isFinite(n) || n <= 0) return null;
      let out = "";
      for (let i = 0; i < n; i++) {
        const part = getCookie(`${key}.${i}`);
        if (part == null) return null;
        out += part;
      }
      return out;
    },

    setItem: (key, value) => {
      const old = getCookie(`${key}.__chunks`);
      if (old) {
        const nOld = Number(old);
        if (Number.isFinite(nOld) && nOld > 0) {
          for (let i=0;i<nOld;i++) delCookie(`${key}.${i}`);
        }
        delCookie(`${key}.__chunks`);
      }
      delCookie(key);

      const str = String(value ?? "");
      const chunks = [];
      for (let i=0;i<str.length;i+=CHUNK_SIZE){
        chunks.push(str.slice(i,i+CHUNK_SIZE));
      }

      setCookie(`${key}.__chunks`, String(chunks.length));
      chunks.forEach((c,i)=>setCookie(`${key}.${i}`,c));
    },

    removeItem: (key) => {
      const meta = getCookie(`${key}.__chunks`);
      if (meta) {
        const n = Number(meta);
        if (Number.isFinite(n) && n > 0) {
          for (let i=0;i<n;i++) delCookie(`${key}.${i}`);
        }
        delCookie(`${key}.__chunks`);
      }
      delCookie(key);
    }
  };
})();

/* supabase client */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth:{
    flowType:"pkce",
    persistSession:true,
    autoRefreshToken:true,
    detectSessionInUrl:true,
    storage:cookieStorage,
    storageKey:"epm-admin-auth"
  }
});

async function ensureSessionFromURL(){
  if(location.search.includes("code=") || location.hash.includes("access_token")){
    history.replaceState({}, document.title, location.pathname);
  }
}

function kickLogin(){
  const next = encodeURIComponent(location.pathname + location.search + location.hash);
  location.replace(`${LOGIN_URL}?next=${next}`);
}

function kickDenied(){
  location.replace(DENIED_URL);
}

/* ⭐ 핵심 가드 (timeout 포함, admin/product와 동일 구조) */
async function guardAdmin(){

  let session;

  try{

    const timeout = (ms) =>
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error("getSession timeout")), ms)
      );

    const { data, error } = await Promise.race([
      sb.auth.getSession(),
      timeout(2000)
    ]);

    if(error) throw error;
    session = data?.session;

  }catch(e){
    console.error("[guard] getSession error:", e);
    return kickLogin();
  }

  const user = session?.user;
  if(!user){
    return kickLogin();
  }

  const email  = user.email;
  const ghUser = user.user_metadata?.user_name;

  const ok =
    (email  && ADMIN_EMAILS.includes(email)) ||
    (ghUser && ADMIN_USERNAMES.includes(ghUser));

  if(!ok){
    return kickDenied();
  }

  document.documentElement.classList.remove("protecting");
}

/* 다른 탭 로그인/로그아웃 대응 */
sb.auth.onAuthStateChange(() => guardAdmin());
</script>
</head>

<body>

<div class="wrap">
<h1>상품 카테고리 관리</h1>
<div class="muted">Supabase 연결 버전</div>

<div class="box">
  <div class="row">
    <input id="q" placeholder="검색">
    <select id="useFilter">
      <option value="">사용여부(전체)</option>
      <option value="Y">사용</option>
      <option value="N">미사용</option>
    </select>
    <button class="btn secondary" id="reloadBtn">새로고침</button>
    <button class="btn" id="addBtn">+ 카테고리 추가</button>
    <span id="countTxt" class="muted"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th>CategoryKey</th>
        <th>카테고리명</th>
        <th>정렬</th>
        <th>사용</th>
        <th>관리</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>
</div>

<div class="modal-backdrop" id="backdrop"></div>
<div class="modal" id="modal">
<h3 id="modalTitle"></h3>

<form id="form">
  <div class="grid">
    <div>
      <label>CategoryKey</label>
      <input id="CategoryKey" class="mono" required />
    </div>
    <div>
      <label>카테고리명</label>
      <input id="CategoryName" required />
    </div>
    <div>
      <label>정렬순서</label>
      <input id="SortOrder" type="number" />
    </div>
  </div>

  <label>사용여부</label>
  <select id="UseYn">
    <option value="Y">Y</option>
    <option value="N">N</option>
  </select>

  <label>비고</label>
  <textarea id="Remark"></textarea>

  <br><br>
  <button class="btn" type="submit" id="saveBtn">저장</button>
  <button class="btn secondary" type="button" id="cancelBtn">취소</button>
  <button class="btn danger" type="button" id="deleteBtn" style="display:none;">삭제</button>
</form>
</div>

<script>
/* ===== 기존 카테고리 관리 로직 (그대로) ===== */

const API_BASE = `${SUPABASE_URL}/rest/v1/productCategory`;

const headers = {
  "apikey": SUPABASE_ANON_KEY,
  "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
  "Content-Type": "application/json",
  "Accept": "application/json"
};

let rows = [];
let editingId = null;
const $ = id => document.getElementById(id);

async function load(){
  $("reloadBtn").disabled = true;
  const res = await fetch(`${API_BASE}?select=*&order=sort_order.asc`, { headers });
  if(!res.ok){ alert("조회 실패 : " + res.status); return; }
  const data = await res.json();

  rows = data.map(x => ({
    id:x.id,
    categoryKey:x.category_key,
    categoryName:x.category_name,
    sortOrder:x.sort_order,
    useYn:x.use_yn,
    remark:x.remark
  }));
  render();
  $("reloadBtn").disabled = false;
}

function render(){
  const tbody = $("tbody");
  tbody.innerHTML = "";

  const q = $("q").value.trim().toLowerCase();
  const useFilter = $("useFilter").value;

  const filtered = rows.filter(r => {
    const key = (r.categoryKey || "").toLowerCase();
    const name = (r.categoryName || "").toLowerCase();
    const matchQ = !q || key.includes(q) || name.includes(q);
    const matchUse = !useFilter || r.useYn === useFilter;
    return matchQ && matchUse;
  });

  filtered.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${r.categoryKey}</td>
      <td>${r.categoryName}</td>
      <td>${r.sortOrder}</td>
      <td><span class="pill">${r.useYn}</span></td>
      <td>
        <button class="btn secondary" onclick="editRow(${r.id})">수정</button>
        <button class="btn danger" onclick="deleteRow(${r.id})">삭제</button>
      </td>`;
    tbody.appendChild(tr);
  });

  $("countTxt").textContent = `${filtered.length}건 / 전체 ${rows.length}건`;
}

$("q").addEventListener("input", render);
$("useFilter").addEventListener("change", render);

function openModal(){
  $("modalTitle").innerText = editingId ? "카테고리 수정" : "카테고리 추가";
  $("backdrop").style.display="block";
  $("modal").style.display="block";
}

function closeModal(){
  $("backdrop").style.display="none";
  $("modal").style.display="none";
  editingId=null;
  $("form").reset();
}

$("addBtn").onclick = ()=>{ editingId=null; openModal(); };

window.editRow = (id)=>{
  const r = rows.find(x=>x.id==id);
  editingId = id;
  $("CategoryKey").value = r.categoryKey;
  $("CategoryKey").disabled = false;
  $("CategoryName").value = r.categoryName;
  $("SortOrder").value = r.sortOrder;
  $("UseYn").value = r.useYn;
  $("Remark").value = r.remark || "";
  openModal();
};

window.deleteRow = async(id)=>{
  if(!confirm("삭제할까요?")) return;
  await fetch(`${API_BASE}?id=eq.${id}`, { method:"DELETE", headers });
  load();
};

$("form").onsubmit = async(e)=>{
  e.preventDefault();

  const body = {
    category_key: $("CategoryKey").value.trim(),
    category_name: $("CategoryName").value.trim(),
    sort_order: Number($("SortOrder").value||0),
    use_yn: $("UseYn").value,
    remark: $("Remark").value.trim()
  };

  if(editingId){
    await fetch(`${API_BASE}?id=eq.${editingId}`, {
      method:"PATCH", headers, body:JSON.stringify(body)
    });
  } else {
    await fetch(API_BASE,{
      method:"POST", headers, body:JSON.stringify(body)
    });
  }

  closeModal();
  load();
};

$("cancelBtn").onclick = closeModal;

/* 초기 로드 */
async function initPage(){
  await ensureSessionFromURL();
  await guardAdmin();
  await load();
}

initPage();

</script>

</body>
</html>

<!doctype html>
<html lang="ko" class="protecting">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>상품 카테고리 관리</title>

  <script>
    // www 정규화(오리진 통일)
    (function enforceWWW(){
      const CANON = "www.eastpowermetal.com";
      if (location.hostname !== CANON) {
        location.replace(`https://${CANON}${location.pathname}${location.search}${location.hash}`);
      }
    })();
  </script>

  <style>
    html.protecting body { visibility: hidden; } /* 권한 체크 전 UI 숨김 */

    :root { --bd:#e5e7eb; --txt:#111827; --mut:#6b7280; }
    body { font-family: Arial, "Malgun Gothic", sans-serif; margin: 24px; color:var(--txt); }
    .wrap { max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 10px; }
    .muted { color: var(--mut); font-size: 12px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .box { border:1px solid var(--bd); border-radius: 12px; padding: 14px; margin-top: 12px; }
    label { display:block; font-size: 13px; margin: 10px 0 6px; }
    input, select, textarea {
      width: 100%; padding: 10px; border:1px solid #d1d5db; border-radius: 10px; font-size: 14px;
    }
    textarea { min-height: 90px; resize: vertical; }
    .grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }

    .btn {
      padding: 10px 14px; border-radius: 10px; border:1px solid #111827;
      background:#111827; color:#fff; cursor:pointer;
    }
    .btn.secondary { background:#fff; color:#111827; }
    .btn.danger { background:#b91c1c; border-color:#b91c1c; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }

    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom:1px solid var(--bd); padding: 10px; text-align:left; font-size: 13px; vertical-align: top; }
    th { background:#fafafa; }
    .pill { display:inline-block; padding: 2px 10px; border-radius:999px; background:#f3f4f6; font-size:12px; }
    .right { margin-left:auto; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    /* modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; }
    .modal { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:min(720px, 92vw);
      background:#fff; border:1px solid var(--bd); border-radius: 14px; padding: 14px; display:none;
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
    }
    .modal h2 { margin: 0 0 10px; font-size: 18px; }
    .modal .footer { margin-top: 12px; display:flex; gap:10px; }
    .error { color:#b91c1c; font-size: 12px; margin-top: 8px; display:none; }
    .top { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .who { color: var(--mut); font-size:12px; }
  </style>

  <!-- Supabase JS SDK v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<div class="wrap">

  <div class="top">
    <h1 style="margin:0;">상품 카테고리 관리</h1>
    <span class="who" id="who"></span>
    <span style="flex:1"></span>
    <button class="btn secondary" type="button" onclick="location.href='/admin/product.html'">제품 목록</button>
    <button class="btn secondary" id="logoutBtn" type="button">로그아웃</button>
  </div>

  <div class="muted">
    목적: 상품 저장 시 <span class="mono">CategoryKey</span>를 함께 저장하기 위한 카테고리 마스터 관리 화면.
  </div>

  <div class="box">
    <div class="row">
      <div style="min-width:260px; flex:1;">
        <input id="q" placeholder="검색: 키/이름(예: busbar, terminalblock_2tier)" />
      </div>
      <div style="min-width:200px;">
        <select id="useFilter">
          <option value="">사용여부(전체)</option>
          <option value="Y">사용(Y)</option>
          <option value="N">미사용(N)</option>
        </select>
      </div>
      <button class="btn secondary" id="reloadBtn" type="button">새로고침</button>
      <button class="btn" id="addBtn" type="button">+ 카테고리 추가</button>
      <span class="right muted" id="countTxt"></span>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:180px;">CategoryKey</th>
          <th>카테고리명</th>
          <th style="width:110px;">정렬</th>
          <th style="width:120px;">사용여부</th>
          <th style="width:220px;">관리</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="backdrop"></div>
<div class="modal" id="modal">
  <h2 id="modalTitle">카테고리 추가</h2>

  <form id="form">
    <div class="grid">
      <div>
        <label>CategoryKey (소문자 영문/숫자/언더바)</label>
        <input id="CategoryKey" class="mono" placeholder="예) busbar / terminalblock_2tier" required />
        <div class="muted">※ 제품 테이블에 저장될 키값. 한번 쓰기 시작하면 변경 비추천.</div>
      </div>

      <div>
        <label>카테고리명</label>
        <input id="CategoryName" placeholder="예) 1. 부스바 / 2. 2단단자대" required />
      </div>

      <div>
        <label>정렬순서</label>
        <input id="SortOrder" type="number" min="0" step="1" placeholder="예) 10" />
      </div>
    </div>

    <div class="grid">
      <div>
        <label>사용여부</label>
        <select id="UseYn">
          <option value="Y">Y (사용)</option>
          <option value="N">N (미사용)</option>
        </select>
      </div>

      <div style="grid-column: span 2;">
        <label>비고</label>
        <textarea id="Remark" placeholder="설명/주의사항/내부메모"></textarea>
      </div>
    </div>

    <div class="error" id="errBox"></div>

    <div class="footer">
      <button class="btn" type="submit" id="saveBtn">저장</button>
      <button class="btn secondary" type="button" id="cancelBtn">취소</button>
      <button class="btn danger right" type="button" id="deleteBtn" style="display:none;">삭제</button>
    </div>
  </form>
</div>

<script>
  // =========================
  // ✅ Supabase 설정 (anon 키는 공개용)
  // =========================
  const SUPABASE_URL = "https://cwwnarmrvpvjptytepdo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3d25hcm1ydnB2anB0eXRlcGRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NzU4NTUsImV4cCI6MjA3NzQ1MTg1NX0.5mvgA_gKdlRaebVRSFIUJRKgp51zke_nffQ2jc8Ad1g";

  // ✅ 카테고리 테이블명
  const TABLE = "productCategory";

  // ✅ 관리자 화이트리스트 (기존 제품등록 화면과 동일)
  const ADMIN_EMAILS = ["chkim.epm@gmail.com"];
  const ADMIN_USERNAMES = ["chkim-epm"];
  const LOGIN_URL  = "/admin/index.html";
  const DENIED_URL = "/admin/denied.html";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // =========================
  // 유틸
  // =========================
  const $ = (id) => document.getElementById(id);

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }

  function showError(msg){
    const box = $("errBox");
    box.style.display = msg ? "block" : "none";
    box.textContent = msg || "";
  }

  function normalizeKey(k){
    // 키는 강제로 소문자 + trim
    return (k || "").trim().toLowerCase();
  }

  // =========================
  // OAuth code/access_token → 세션 교환
  // =========================
  async function ensureSessionFromURL() {
    if (location.search.includes("code=") || location.hash.includes("access_token")) {
      try { await sb.auth.exchangeCodeForSession(window.location.href); } catch (_) {}
    }
  }

  // =========================
  // 관리자 가드
  // =========================
  function kickLogin(){
    const next = encodeURIComponent(location.pathname + location.search);
    location.replace(`${LOGIN_URL}?next=${next}`);
  }
  function kickDenied(){
    location.replace(DENIED_URL);
  }

  async function guardAdmin() {
    const { data: { session } } = await sb.auth.getSession();
    const user = session?.user;
    if (!user) return kickLogin();

    const email = user.email;
    const ghUser = user.user_metadata?.user_name;
    const ok = (email && ADMIN_EMAILS.includes(email)) || (ghUser && ADMIN_USERNAMES.includes(ghUser));
    if (!ok) return kickDenied();

    $("who").textContent = `(${email || ghUser})`;
    document.documentElement.classList.remove("protecting");
  }

  // 안전장치: 가드 실패 시 5초 후 로그인으로
  setTimeout(() => {
    if (document.documentElement.classList.contains("protecting")) kickLogin();
  }, 5000);

  sb.auth.onAuthStateChange(() => guardAdmin());

  $("logoutBtn").addEventListener("click", async () => {
    await sb.auth.signOut();
    kickLogin();
  });

  // =========================
  // 화면 상태
  // =========================
  let rows = [];
  let editingId = null;

  function validateForm(){
    const key = normalizeKey($("CategoryKey").value);
    const name = ($("CategoryName").value || "").trim();

    if (!key) return "CategoryKey는 필수야.";
    if (!/^[a-z0-9_]+$/.test(key)) return "CategoryKey는 소문자 영문/숫자/언더바(_)만 허용.";
    if (!name) return "카테고리명은 필수야.";

    // 신규등록일 때 화면 기준 중복 체크
    if (!editingId){
      const dup = rows.some(r => String(r.categoryKey || "").toLowerCase() === key);
      if (dup) return "이미 존재하는 CategoryKey야.";
    }
    return null;
  }

  function openModal(mode, data){
    showError("");
    $("backdrop").style.display = "block";
    $("modal").style.display = "block";

    if (mode === "add"){
      editingId = null;
      $("modalTitle").textContent = "카테고리 추가";
      $("deleteBtn").style.display = "none";

      $("CategoryKey").disabled = false;
      $("CategoryKey").value = "";
      $("CategoryName").value = "";
      $("SortOrder").value = "";
      $("UseYn").value = "Y";
      $("Remark").value = "";
    } else {
      editingId = data.id;
      $("modalTitle").textContent = "카테고리 수정";
      $("deleteBtn").style.display = "inline-block";

      $("CategoryKey").disabled = true;
      $("CategoryKey").value = data.categoryKey ?? "";
      $("CategoryName").value = data.categoryName ?? "";
      $("SortOrder").value = (data.sortOrder ?? "");
      $("UseYn").value = data.useYn ?? "Y";
      $("Remark").value = data.remark ?? "";
    }
  }

  function closeModal(){
    $("backdrop").style.display = "none";
    $("modal").style.display = "none";
  }

  function render(){
    const q = ($("q").value || "").trim().toLowerCase();
    const useFilter = $("useFilter").value;

    const filtered = rows.filter(r => {
      const key = (r.categoryKey || "").toLowerCase();
      const name = (r.categoryName || "").toLowerCase();
      const okQ = !q || key.includes(q) || name.includes(q);
      const okUse = !useFilter || (r.useYn === useFilter);
      return okQ && okUse;
    });

    $("countTxt").textContent = `${filtered.length}건 / 전체 ${rows.length}건`;

    const tbody = $("tbody");
    tbody.innerHTML = "";

    filtered.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(r.categoryKey || "")}</td>
        <td>
          <div>${escapeHtml(r.categoryName || "")}</div>
          ${r.remark ? `<div class="muted" style="margin-top:4px;">${escapeHtml(r.remark)}</div>` : ""}
        </td>
        <td>${r.sortOrder ?? ""}</td>
        <td>${r.useYn === "Y" ? `<span class="pill">Y</span>` : `<span class="pill">N</span>`}</td>
        <td>
          <div class="row">
            <button class="btn secondary" data-edit="${r.id}" type="button">수정</button>
            <button class="btn danger" data-del="${r.id}" type="button">삭제</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button[data-edit]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-edit");
        const row = rows.find(x => String(x.id) === String(id));
        if (!row) return;
        openModal("edit", row);
      });
    });

    tbody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-del");
        const row = rows.find(x => String(x.id) === String(id));
        if (!row) return;
        if (!confirm(`[${row.categoryKey}] 삭제할까? (연결된 상품이 있으면 삭제 제한 추천)`)) return;
        await deleteRow(id);
      });
    });
  }

  // =========================
  // ✅ Supabase CRUD (여기가 저장 에러 해결 포인트)
  // =========================
  async function load(){
    $("reloadBtn").disabled = true;
    try {
      const { data, error } = await sb
        .from(TABLE)
        .select("*")
        .order("sortOrder", { ascending: true, nullsFirst: false })
        .order("created_at", { ascending: true });

      if (error) throw error;
      rows = data || [];
      render();
    } catch (e){
      alert(e?.message || "조회 중 오류");
      console.error(e);
    } finally {
      $("reloadBtn").disabled = false;
    }
  }

  function friendlyDbError(e){
    const msg = String(e?.message || e || "");
    // 유니크 제약(예: categoryKey unique) 걸려있을 때 자주 발생
    if (msg.toLowerCase().includes("duplicate") || msg.toLowerCase().includes("unique")) {
      return "이미 존재하는 CategoryKey야. 다른 키로 저장해줘.";
    }
    // RLS/권한 문제
    if (msg.toLowerCase().includes("rls") || msg.toLowerCase().includes("permission") || msg.includes("42501")) {
      return "권한(RLS) 때문에 저장이 막혔어. productCategory 정책(INSERT/UPDATE/DELETE) 확인 필요.";
    }
    return msg || "저장 중 오류";
  }

  async function createRow(payload){
    const { error } = await sb.from(TABLE).insert(payload);
    if (error) throw error;
  }

  async function updateRow(id, payload){
    // 키는 잠금이라 categoryKey는 서버에서 굳이 업데이트 안 하도록 제외 권장
    const { categoryKey, ...rest } = payload;
    const { error } = await sb.from(TABLE).update(rest).eq("id", id);
    if (error) throw error;
  }

  async function deleteRow(id){
    try {
      const { error } = await sb.from(TABLE).delete().eq("id", id);
      if (error) throw error;
      await load();
    } catch (e){
      alert(friendlyDbError(e));
      console.error(e);
    }
  }

  // =========================
  // Events
  // =========================
  $("addBtn").addEventListener("click", () => openModal("add"));
  $("cancelBtn").addEventListener("click", closeModal);
  $("backdrop").addEventListener("click", closeModal);

  $("reloadBtn").addEventListener("click", load);
  $("q").addEventListener("input", render);
  $("useFilter").addEventListener("change", render);

  $("deleteBtn").addEventListener("click", async () => {
    if (!editingId) return;
    const row = rows.find(x => String(x.id) === String(editingId));
    if (!row) return;
    if (!confirm(`[${row.categoryKey}] 삭제할까?`)) return;
    closeModal();
    await deleteRow(editingId);
  });

  $("form").addEventListener("submit", async (e) => {
    e.preventDefault();
    showError("");

    const err = validateForm();
    if (err){ showError(err); return; }

    const payload = {
      categoryKey: normalizeKey($("CategoryKey").value),
      categoryName: ($("CategoryName").value || "").trim(),
      sortOrder: $("SortOrder").value ? Number($("SortOrder").value) : 0,
      useYn: $("UseYn").value,
      remark: ($("Remark").value || "").trim() || null
    };

    try {
      $("saveBtn").disabled = true;

      if (!editingId){
        await createRow(payload);
      } else {
        await updateRow(editingId, payload);
      }

      closeModal();
      await load();
      alert("저장 완료!");
    } catch (e){
      showError(friendlyDbError(e));
      console.error(e);
    } finally {
      $("saveBtn").disabled = false;
    }
  });

  // =========================
  // Init
  // =========================
  (async () => {
    await ensureSessionFromURL();
    await guardAdmin();
    await load();
  })();
</script>
</body>
</html>

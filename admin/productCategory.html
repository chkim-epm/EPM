<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>상품 카테고리 관리</title>
  <style>
    :root { --bd:#e5e7eb; --txt:#111827; --mut:#6b7280; }
    body { font-family: Arial, "Malgun Gothic", sans-serif; margin: 24px; color:var(--txt); }
    .wrap { max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 10px; }
    .muted { color: var(--mut); font-size: 12px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .box { border:1px solid var(--bd); border-radius: 12px; padding: 14px; margin-top: 12px; }
    label { display:block; font-size: 13px; margin: 10px 0 6px; }
    input, select, textarea {
      width: 100%; padding: 10px; border:1px solid #d1d5db; border-radius: 10px; font-size: 14px;
    }
    textarea { min-height: 90px; resize: vertical; }
    .grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }

    .btn {
      padding: 10px 14px; border-radius: 10px; border:1px solid #111827;
      background:#111827; color:#fff; cursor:pointer;
    }
    .btn.secondary { background:#fff; color:#111827; }
    .btn.danger { background:#b91c1c; border-color:#b91c1c; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }

    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom:1px solid var(--bd); padding: 10px; text-align:left; font-size: 13px; vertical-align: top; }
    th { background:#fafafa; }
    .pill { display:inline-block; padding: 2px 10px; border-radius:999px; background:#f3f4f6; font-size:12px; }
    .right { margin-left:auto; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    /* modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; }
    .modal { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:min(720px, 92vw);
      background:#fff; border:1px solid var(--bd); border-radius: 14px; padding: 14px; display:none;
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
    }
    .modal h2 { margin: 0 0 10px; font-size: 18px; }
    .modal .footer { margin-top: 12px; display:flex; gap:10px; }
    .error { color:#b91c1c; font-size: 12px; margin-top: 8px; display:none; }
  </style>
</head>

<body>
<div class="wrap">
  <h1>상품 카테고리 관리</h1>
  <div class="muted">
    목적: 상품 저장 시 <span class="mono">CategoryKey</span>를 함께 저장하기 위한 카테고리 마스터 관리 화면.
  </div>

  <div class="box">
    <div class="row">
      <div style="min-width:260px; flex:1;">
        <input id="q" placeholder="검색: 키/이름(예: busbar, 2단단자대)" />
      </div>
      <div style="min-width:200px;">
        <select id="useFilter">
          <option value="">사용여부(전체)</option>
          <option value="Y">사용(Y)</option>
          <option value="N">미사용(N)</option>
        </select>
      </div>
      <button class="btn secondary" id="reloadBtn">새로고침</button>
      <button class="btn" id="addBtn">+ 카테고리 추가</button>
      <span class="right muted" id="countTxt"></span>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:160px;">CategoryKey</th>
          <th>카테고리명</th>
          <th style="width:110px;">정렬</th>
          <th style="width:120px;">사용여부</th>
          <th style="width:220px;">관리</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="backdrop"></div>
<div class="modal" id="modal">
  <h2 id="modalTitle">카테고리 추가</h2>

  <form id="form">
    <div class="grid">
      <div>
        <label>CategoryKey (영문/숫자/언더바)</label>
        <input id="CategoryKey" class="mono" placeholder="예) busbar / terminalblock_2tier" required />
        <div class="muted">※ 제품 테이블에 저장될 키값. 한번 쓰기 시작하면 변경 비추천.</div>
      </div>

      <div>
        <label>카테고리명</label>
        <input id="CategoryName" placeholder="예) 1. 부스바 / 2. 2단단자대" required />
      </div>

      <div>
        <label>정렬순서</label>
        <input id="SortOrder" type="number" min="0" step="1" placeholder="예) 10" />
      </div>
    </div>

    <div class="grid">
      <div>
        <label>사용여부</label>
        <select id="UseYn">
          <option value="Y">Y (사용)</option>
          <option value="N">N (미사용)</option>
        </select>
      </div>

      <div style="grid-column: span 2;">
        <label>비고</label>
        <textarea id="Remark" placeholder="설명/주의사항/내부메모"></textarea>
      </div>
    </div>

    <div class="error" id="errBox"></div>

    <div class="footer">
      <button class="btn" type="submit" id="saveBtn">저장</button>
      <button class="btn secondary" type="button" id="cancelBtn">취소</button>
      <button class="btn danger right" type="button" id="deleteBtn" style="display:none;">삭제</button>
    </div>
  </form>

  <div class="muted" style="margin-top:10px;">
    Supabase REST(PostgREST) 직접 호출 방식(A) 적용 버전.
  </div>
</div>

<script>
  // =========================
  // ✅ Supabase REST 설정 (여기만 채우면 됨)
  // =========================
  const SUPABASE_URL = "https://<PROJECT_REF>.supabase.co";
  const SUPABASE_ANON_KEY = "<ANON_KEY>";

  // 테이블명: productCategory
  const API_BASE = `${SUPABASE_URL}/rest/v1/productCategory`;

  const headers = {
    "apikey": SUPABASE_ANON_KEY,
    "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
    "Content-Type": "application/json",
    "Accept": "application/json"
  };

  // ====== 상태 ======
  let rows = [];
  let editingId = null; // 수정 시 사용 (PK)

  const $ = (id) => document.getElementById(id);

  function showError(msg){
    const box = $("errBox");
    box.style.display = msg ? "block" : "none";
    box.textContent = msg || "";
  }

  function openModal(mode, data){
    showError("");
    $("backdrop").style.display = "block";
    $("modal").style.display = "block";

    if (mode === "add"){
      editingId = null;
      $("modalTitle").textContent = "카테고리 추가";
      $("deleteBtn").style.display = "none";

      $("CategoryKey").disabled = false;
      $("CategoryKey").value = "";
      $("CategoryName").value = "";
      $("SortOrder").value = "";
      $("UseYn").value = "Y";
      $("Remark").value = "";
    } else {
      editingId = data.id;
      $("modalTitle").textContent = "카테고리 수정";
      $("deleteBtn").style.display = "inline-block";

      // 키는 원칙적으로 변경 비추천이라 수정 시 잠금
      $("CategoryKey").disabled = true;

      $("CategoryKey").value = data.categoryKey ?? "";
      $("CategoryName").value = data.categoryName ?? "";
      $("SortOrder").value = (data.sortOrder ?? "");
      $("UseYn").value = data.useYn ?? "Y";
      $("Remark").value = data.remark ?? "";
    }
  }

  function closeModal(){
    $("backdrop").style.display = "none";
    $("modal").style.display = "none";
  }

  function normalizeKey(k){
    return (k || "").trim();
  }

  function validateForm(){
    const key = normalizeKey($("CategoryKey").value);
    const name = ($("CategoryName").value || "").trim();

    if (!key) return "CategoryKey는 필수야.";
    if (!/^[a-z0-9_]+$/.test(key)) return "CategoryKey는 소문자 영문/숫자/언더바(_)만 허용.";
    if (!name) return "카테고리명은 필수야.";

    // 신규등록일 때만 중복 체크(화면 기준)
    if (!editingId){
      const dup = rows.some(r => (r.categoryKey || "").toLowerCase() === key.toLowerCase());
      if (dup) return "이미 존재하는 CategoryKey야.";
    }
    return null;
  }

  function render(){
    const q = ($("q").value || "").trim().toLowerCase();
    const useFilter = $("useFilter").value;

    const filtered = rows.filter(r => {
      const key = (r.categoryKey || "").toLowerCase();
      const name = (r.categoryName || "").toLowerCase();
      const okQ = !q || key.includes(q) || name.includes(q);
      const okUse = !useFilter || (r.useYn === useFilter);
      return okQ && okUse;
    });

    $("countTxt").textContent = `${filtered.length}건 / 전체 ${rows.length}건`;

    const tbody = $("tbody");
    tbody.innerHTML = "";

    filtered.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(r.categoryKey || "")}</td>
        <td>
          <div>${escapeHtml(r.categoryName || "")}</div>
          ${r.remark ? `<div class="muted" style="margin-top:4px;">${escapeHtml(r.remark)}</div>` : ""}
        </td>
        <td>${r.sortOrder ?? ""}</td>
        <td>${r.useYn === "Y" ? `<span class="pill">Y</span>` : `<span class="pill">N</span>`}</td>
        <td>
          <div class="row">
            <button class="btn secondary" data-edit="${r.id}">수정</button>
            <button class="btn danger" data-del="${r.id}">삭제</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button[data-edit]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-edit");
        const row = rows.find(x => String(x.id) === String(id));
        if (!row) return;
        openModal("edit", row);
      });
    });

    tbody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-del");
        const row = rows.find(x => String(x.id) === String(id));
        if (!row) return;
        if (!confirm(`[${row.categoryKey}] 삭제할까? (연결된 상품이 있으면 삭제 제한 추천)`)) return;
        await deleteRow(id);
      });
    });
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }

  // =========================
  // ✅ Supabase REST Calls (A)
  // =========================
  async function load(){
    $("reloadBtn").disabled = true;
    try {
      // select=* 필수, order 정렬
      const res = await fetch(`${API_BASE}?select=*&order=sort_order.asc,id.desc`, {
        method: "GET",
        headers
      });
      if (!res.ok) throw new Error(`조회 실패 (${res.status})`);
      const data = await res.json();

      // DB(snake_case) -> 화면(camelCase) 매핑
      rows = data.map(x => ({
        id: x.id,
        categoryKey: x.category_key,
        categoryName: x.category_name,
        sortOrder: x.sort_order,
        useYn: x.use_yn,
        remark: x.remark
      }));

      render();
    } catch (e){
      alert(e.message || "조회 중 오류");
    } finally {
      $("reloadBtn").disabled = false;
    }
  }

  async function createRow(payload){
    const body = {
      category_key: payload.categoryKey,
      category_name: payload.categoryName,
      sort_order: payload.sortOrder,
      use_yn: payload.useYn,
      remark: payload.remark
    };

    const res = await fetch(API_BASE, {
      method: "POST",
      headers: { ...headers, "Prefer": "return=minimal" },
      body: JSON.stringify(body)
    });

    if (!res.ok){
      const msg = await safeReadText(res);
      throw new Error(msg || `저장 실패 (${res.status})`);
    }
  }

  async function updateRow(id, payload){
    const body = {
      // category_key는 잠궈놔서 전송 안 해도 됨
      category_name: payload.categoryName,
      sort_order: payload.sortOrder,
      use_yn: payload.useYn,
      remark: payload.remark
    };

    const res = await fetch(`${API_BASE}?id=eq.${encodeURIComponent(id)}`, {
      method: "PATCH",
      headers: { ...headers, "Prefer": "return=minimal" },
      body: JSON.stringify(body)
    });

    if (!res.ok){
      const msg = await safeReadText(res);
      throw new Error(msg || `수정 실패 (${res.status})`);
    }
  }

  async function deleteRow(id){
    try {
      const res = await fetch(`${API_BASE}?id=eq.${encodeURIComponent(id)}`, {
        method: "DELETE",
        headers: { ...headers, "Prefer": "return=minimal" }
      });
      if (!res.ok){
        const msg = await safeReadText(res);
        throw new Error(msg || `삭제 실패 (${res.status})`);
      }
      await load();
    } catch(e){
      alert(e.message || "삭제 중 오류");
    }
  }

  async function safeReadText(res){
    try { return await res.text(); } catch { return ""; }
  }

  // ====== events ======
  $("addBtn").addEventListener("click", () => openModal("add"));
  $("cancelBtn").addEventListener("click", closeModal);
  $("backdrop").addEventListener("click", closeModal);

  $("reloadBtn").addEventListener("click", load);
  $("q").addEventListener("input", render);
  $("useFilter").addEventListener("change", render);

  $("deleteBtn").addEventListener("click", async () => {
    if (!editingId) return;
    const row = rows.find(x => String(x.id) === String(editingId));
    if (!row) return;
    if (!confirm(`[${row.categoryKey}] 삭제할까?`)) return;
    closeModal();
    await deleteRow(editingId);
  });

  $("form").addEventListener("submit", async (e) => {
    e.preventDefault();
    showError("");

    const err = validateForm();
    if (err){ showError(err); return; }

    const payload = {
      categoryKey: normalizeKey($("CategoryKey").value),
      categoryName: ($("CategoryName").value || "").trim(),
      sortOrder: $("SortOrder").value ? Number($("SortOrder").value) : 0,
      useYn: $("UseYn").value,
      remark: ($("Remark").value || "").trim()
    };

    try {
      $("saveBtn").disabled = true;

      if (!editingId){
        await createRow(payload);
      } else {
        await updateRow(editingId, payload);
      }

      closeModal();
      await load();
      alert("저장 완료!");
    } catch (e){
      showError(e.message || "저장 중 오류");
    } finally {
      $("saveBtn").disabled = false;
    }
  });

  // 최초 로드
  load();
</script>
</body>
</html>

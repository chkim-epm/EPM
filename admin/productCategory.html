<!doctype html>
<html lang="ko" class="protecting">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>상품 카테고리 관리</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    html.protecting body { visibility: hidden; }
    :root { --bd:#e5e7eb; --txt:#111827; --mut:#6b7280; }
    body { font-family: Arial, "Malgun Gothic", sans-serif; margin:24px; color:var(--txt); }
    .wrap { max-width:1100px; margin:auto; }
    .top { display:flex; gap:10px; align-items:center; }
    .who { color:var(--mut); font-size:12px; }
    .box { border:1px solid var(--bd); border-radius:12px; padding:14px; margin-top:14px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { border-bottom:1px solid var(--bd); padding:10px; font-size:13px; }
    th { background:#fafafa; }
    .btn { padding:8px 14px; border-radius:8px; border:1px solid #111; background:#111; color:#fff; cursor:pointer; }
    .btn.secondary{ background:#fff; color:#111;}
    .btn.danger{ background:#b91c1c; border-color:#b91c1c;}
    .mono{font-family:ui-monospace,monospace;}
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.3); display:none;}
    .modal{position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:#fff; border:1px solid var(--bd); border-radius:12px; padding:14px; display:none; width:600px;}
    .error{color:#b91c1c; font-size:12px; display:none;}
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <h2>상품 카테고리 관리</h2>
    <span class="who" id="who"></span>
    <span style="flex:1"></span>
    <button class="btn secondary" onclick="location.href='/admin/product.html'">제품목록</button>
    <button class="btn secondary" id="logoutBtn">로그아웃</button>
  </div>

  <div class="box">
    <button class="btn" id="addBtn">+ 카테고리 추가</button>
    <span id="countTxt" style="margin-left:10px; font-size:12px;"></span>

    <table>
      <thead>
        <tr>
          <th>CategoryKey</th>
          <th>카테고리명</th>
          <th>정렬</th>
          <th>사용</th>
          <th>관리</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- modal -->
<div class="modal-backdrop" id="backdrop"></div>
<div class="modal" id="modal">
  <h3 id="modalTitle"></h3>

  <input id="CategoryKey" class="mono" placeholder="category key"><br><br>
  <input id="CategoryName" placeholder="카테고리명"><br><br>
  <input id="SortOrder" type="number" placeholder="정렬"><br><br>
  <select id="UseYn">
    <option value="Y">Y</option>
    <option value="N">N</option>
  </select><br><br>
  <textarea id="Remark" placeholder="비고"></textarea>

  <div class="error" id="errBox"></div><br>

  <button class="btn" id="saveBtn">저장</button>
  <button class="btn secondary" id="cancelBtn">취소</button>
  <button class="btn danger" id="deleteBtn" style="float:right; display:none;">삭제</button>
</div>

<script>
/* ============================
   Supabase 설정
============================ */
const SUPABASE_URL = "https://cwwnarmrvpvjptytepdo.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY"; // ← 네 anon 그대로 유지

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const TABLE = "productCategory";

const ADMIN_EMAILS = ["chkim.epm@gmail.com"];
const ADMIN_USERNAMES = ["chkim-epm"];

const LOGIN_URL = "/admin/index.html";
const DENIED_URL = "/admin/denied.html";

const $ = id => document.getElementById(id);

let rows = [];
let editingId = null;

/* ============================
   세션 교환
============================ */
async function ensureSessionFromURL(){
  if (location.search.includes("code=")) {
    await sb.auth.exchangeCodeForSession(location.href);
  }
}

/* ============================
   로그인 이동 (루프 방지)
============================ */
function kickLogin(){
  if (location.pathname.endsWith("/admin/index.html")) return;
  const next = encodeURIComponent(location.pathname);
  location.replace(`${LOGIN_URL}?next=${next}`);
}
function kickDenied(){ location.replace(DENIED_URL); }

/* ============================
   관리자 가드 (루프 해결본)
============================ */
async function guardAdmin(){
  const { data:{session} } = await sb.auth.getSession();

  if (!session || !session.user) return kickLogin();

  const user = session.user;
  const email = user.email;
  const gh = user.user_metadata?.user_name;

  const ok =
    (email && ADMIN_EMAILS.includes(email)) ||
    (gh && ADMIN_USERNAMES.includes(gh));

  if (!ok) return kickDenied();

  $("who").textContent = `(${email || gh})`;
  document.documentElement.classList.remove("protecting");
}

/* fallback 안전장치 */
setTimeout(()=>{
  if (document.documentElement.classList.contains("protecting")
      && !location.pathname.endsWith("/admin/index.html")) {
    kickLogin();
  }
},5000);

/* 로그아웃 */
$("logoutBtn").addEventListener("click", async()=>{
  await sb.auth.signOut();
  kickLogin();
});

/* ============================
   CRUD
============================ */
async function load(){
  const {data,error} = await sb.from(TABLE).select("*").order("sortOrder");
  if(error){ alert(error.message); return; }
  rows = data;
  render();
}

function render(){
  $("countTxt").textContent = `${rows.length} 건`;
  const tbody = $("tbody");
  tbody.innerHTML = "";

  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${r.categoryKey}</td>
      <td>${r.categoryName}</td>
      <td>${r.sortOrder ?? ""}</td>
      <td>${r.useYn}</td>
      <td>
        <button class="btn secondary" data-edit="${r.id}">수정</button>
        <button class="btn danger" data-del="${r.id}">삭제</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("[data-edit]").forEach(b=>{
    b.onclick=()=>{
      const row = rows.find(x=>x.id==b.dataset.edit);
      openModal("edit",row);
    }
  });

  tbody.querySelectorAll("[data-del]").forEach(b=>{
    b.onclick=()=>deleteRow(b.dataset.del);
  });
}

async function createRow(payload){
  const {error} = await sb.from(TABLE).insert(payload);
  if(error) throw error;
}

async function updateRow(id,payload){
  const {error} = await sb.from(TABLE).update(payload).eq("id",id);
  if(error) throw error;
}

async function deleteRow(id){
  if(!confirm("삭제할까요?")) return;
  const {error} = await sb.from(TABLE).delete().eq("id",id);
  if(error) alert(error.message);
  await load();
}

/* ============================
   Modal
============================ */
function openModal(mode,data){
  $("backdrop").style.display="block";
  $("modal").style.display="block";

  if(mode==="add"){
    editingId=null;
    $("modalTitle").innerText="카테고리 추가";
    $("deleteBtn").style.display="none";
    $("CategoryKey").disabled=false;

    $("CategoryKey").value="";
    $("CategoryName").value="";
    $("SortOrder").value="";
    $("UseYn").value="Y";
    $("Remark").value="";
  } else {
    editingId=data.id;
    $("modalTitle").innerText="카테고리 수정";
    $("deleteBtn").style.display="inline-block";
    $("CategoryKey").disabled=true;

    $("CategoryKey").value=data.categoryKey;
    $("CategoryName").value=data.categoryName;
    $("SortOrder").value=data.sortOrder;
    $("UseYn").value=data.useYn;
    $("Remark").value=data.remark ?? "";
  }
}

function closeModal(){
  $("backdrop").style.display="none";
  $("modal").style.display="none";
}

$("addBtn").onclick=()=>openModal("add");
$("cancelBtn").onclick=closeModal;

$("saveBtn").onclick=async()=>{
  const payload={
    categoryKey: $("CategoryKey").value.trim().toLowerCase(),
    categoryName: $("CategoryName").value.trim(),
    sortOrder: Number($("SortOrder").value||0),
    useYn: $("UseYn").value,
    remark: $("Remark").value.trim()||null
  };

  try{
    if(!editingId) await createRow(payload);
    else await updateRow(editingId,payload);
    closeModal();
    await load();
    alert("저장 완료");
  }catch(e){
    $("errBox").style.display="block";
    $("errBox").innerText=e.message;
  }
};

$("deleteBtn").onclick=async()=>{
  await deleteRow(editingId);
  closeModal();
};

/* ============================
   INIT
============================ */
(async()=>{
  await ensureSessionFromURL();
  await guardAdmin();
  await load();
})();
</script>
</body>
</html>
